<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<!-- <link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html"> -->

<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="rebelcricket-icons.html">
<link rel="import" href="rebelcricket-design.html">
<link rel="import" href="rebelcricket-vendor.html">

<script src="models.js"></script>
<script src="util.js"></script>
<script src="underscore-min.js"></script>

<dom-module id="rebelcricket-quote">
  <template>
    <style is="custom-style" include="shared-styles">    
      :host {
        font-size: 16px;
        --primary-color: red;
        --default-primary-color: red;
      }

      paper-button.custom, paper-fab.custom {
        background: rgba(255,0,0,0.8);
        
        margin: 1em;
        display: inline-block;
      }

      paper-button.custom:hover, paper-fab.custom:hover {
        background: red;
        color: black;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-input, paper-textarea {
        width: 100%;
        --paper-input-container-color: black;
        --paper-input-container-input-color: black;
      }

      paper-menu {
        --paper-menu-selected-item: {
          color: red;
        }
      }

      hr {
        width: 97%;
      }

      .section-label {
        justify-content: center;
        font-size: 20px;
        font-weight: 100;
        text-transform: uppercase;
        width: 100%;
        background-color: #333;
        border-radius: 5px;
        margin-bottom: 1em;
      }
      .section-label span{
        color: white;
        height: 1.5em;
        text-align: center;
        padding-left: 0.5em;
        padding-right: 0.5em;
      }
      .rebel-font{
        font-family: 'ObelixPro';
        font-weight: 100;
        font-size: 2em;
        line-height: 1em;
      }

      .center{
        text-align: center;
        justify-content: center;
        width: 100%;
      }

      .group{
        border: thin solid #666;
        border-radius: 5px;
        margin: 1em;
      }
      
     

      @media (max-width: 600px) {
        .section-label span{
       
          height: auto;
          padding: 0 2px 0 2px;
        }
      }

      @media (max-width: 875px) {
        .section-label span{
          height: auto;
        }
      }


    </style>
 <!--    <app-route
        route="[[route]]"
        pattern="/:order_id"
        data="{{routeData}}"></app-route> -->

<!--     <app-pouchdb-document
      db-name="http://rebelcricket.lacuna.club:5984/models"
      doc-id="order"
      data="{{orderModel}}">
    </app-pouchdb-document> -->

    <app-pouchdb-conflict-resolution
      strategy="lastWriteWins">
    </app-pouchdb-conflict-resolution>

    <app-pouchdb-document
      db-name="http://rebelcricket.lacuna.club:5984/orders"
      doc-id="{{orderID}}"
      data="{{order}}">
    </app-pouchdb-document>
  
    

<paper-dialog id="scrolling">
  <paper-dialog-scrollable>
    <rebelcricket-vendor></rebelcricket-vendor>
  </paper-dialog-scrollable>
  <div class="buttons">
    <paper-button class="custom">I don't know</paper-button>
    <paper-button class="custom">I don't care</paper-button>
    <paper-button class="custom">Something else</paper-button>
  </div>
</paper-dialog>

    <div class="">
     <!--  <header class="center">
        <h1 class="rebelcricket-header">Order</h1>
      </header> -->

      <div class="row">
        <div class="col s12 center">
          <h1 class="rebel-heading">Quote</h1>
        </div>
      </div>
        
      <div class="container flex-center-justified">

        <div class="center">

          

        </div>
      </div>


      <div class="">
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>[[order.client_contact_information.label]]</span>
              </div>
              <template is="dom-repeat" items="{{order.client_contact_information.items}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>
          </div>
          
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Services</span>
              </div>
              
              
              <template is="dom-repeat" items="{{order.services}}" as="orderService">
                <div class="col s10 center">
                  <paper-dropdown-menu label="Service" on-iron-select="_serviceSelected">
                    <paper-listbox class="dropdown-content" selected="[[orderService.value]]">
                      <template is="dom-repeat" items="{{services}}">
                        <paper-item value="[[item.value]]">[[item.name]]</paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>
                </div>
                <div class="col s2">
                  <paper-fab mini on-tap="_removeService" icon="remove" class="custom"></paper-fab>
                  <paper-tooltip>Remove Service</paper-tooltip>
                </div>
              

                <div class="serviceItems col s12 center">
                  <template is="dom-if" if="[[_isApparelService(orderService)]]">
                    <template is="dom-repeat" items="{{order.line_items.items}}">
                      <div class="col s12 group">
                        <div class="col s4 m3 l2">
      
                          <paper-menu-button ignore-select>
                            <paper-icon-button icon="add" class="dropdown-trigger"></paper-icon-button>
                            <paper-menu class="dropdown-content" multi>
                              <paper-item>XS</paper-item>
                              <paper-item>S</paper-item>
                              <paper-item>M</paper-item>
                              <paper-item>L</paper-item>
                              <paper-item>XL</paper-item>
                              <paper-item>2XL</paper-item>
                              <paper-item>3XL</paper-item>
                              <paper-item>4XL</paper-item>
                              <paper-item>Other</paper-item>
                            </paper-menu>
                          </paper-menu-button>
                          <small>sizes</small>

                        </div>

                          <div class$="col [[item.col]]">
                            <template is="dom-if" if="[[item.on_tap]]">
                              <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}" readonly$="[[item.readonly]]" on-tap="_openDialog"></paper-input>
                            </template>
                            <template is="dom-if" if="[[!item.on_tap]]">
                              <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}" readonly$="[[item.readonly]]"></paper-input>
                            </template>

                          </div>
                        <div class="col s2">
                          <paper-fab mini on-tap="_removeLineItemRow" icon="remove" class="custom"></paper-fab>
                          <paper-tooltip>Remove Textile</paper-tooltip>
                        </div>
                      </div>
                    </template>
                    <div class="col s12 center">
        <!--               <paper-button class="custom" on-tap="_addLineItemRow" raised>&plus;</paper-button> -->
                     
    
                        <paper-button class="custom" on-tap="_addLineItemRow">Add another textile</paper-button>
                    </div>

                  </template>
                </div>
                

              </template>
             

              <div class="col s12 center">
                <paper-button class="custom" on-tap="_addAnotherService">[[addServiceButtonText]]</paper-button>
              </div>

            </div>

          </div>
          

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Graphics</span>
              </div>  
            </div>
            


            <div class="col s4">
             
              <template is="dom-repeat" items="{{_attachmentKeys(order._attachments)}}" as="attachment">
              <!-- rebelcricket.lacuna.club -->
                <img src="http://localhost:5984/cats/{{item._id}}/{{ attachment }}" height="50" width="50">
              </template>
          
              <br>
            </div>

            <div class="col s8">

              <label for="orderDesignFile">Add Image</label>
              <input id="orderDesignFile" type="file"></input>
            </div>



          </div>

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Other</span>
              </div>

              <div class="col s8">
                <paper-dialog id="dateNeededPicker" class="paper-date-picker-dialog" modal>
                  <paper-date-picker id="picker" date="{{dateNeeded}}" min-date="[[now]]"></paper-date-picker>
                  <div class="buttons">
                    <paper-button class="custom" dialog-confirm>Done</paper-button>
                  </div>
                </paper-dialog>
                
                <paper-toggle-button class="red" on-tap="_toggleNeedDate" checked="{{order.need_by_date}}">Do you need this by a certain date?</paper-toggle-button>
              
              </div>

              <div class="col s4">
                <template is="dom-if" if="[[order.need_by_date]]">
                <span id="needsDateContainer">
                  [[order.date_needed]]
                  <paper-fab mini on-tap="_openDatePicker" icon="calendar" class="custom"></paper-fab>
                  <paper-tooltip>Pick Date</paper-tooltip>
                </span>
                </template>
              </div>

              <div class="col s12">
                <paper-textarea rows="4" label="Notes" value="{{order.notes}}"></paper-textarea>
                <small>Please add any additional information or questions.</small>
              </div>

            </div>
          </div>
          
      </div>



         <!--  <paper-dropdown-menu label="Style" on-iron-select="_styleSelected">
            <paper-listbox class="dropdown-content" selected="0">
              <paper-item value="crew">Crew</paper-item>
              <paper-item value="womens_crew">Women's Crew</paper-item>
              <paper-item value="hoodie">Hoodie</paper-item>
              <paper-item value="longsleeve">Long Sleeve</paper-item>
            </paper-listbox>
          </paper-dropdown-menu> -->
        <!--   <paper-swatch-picker color="{{designElementColor}}" column-count=4 color-list='["#000000", "#65a5f2", "#83be54", "#f0d551", "#e5943c", "#a96ddb", "#B20000", "#ffffff"]'></paper-swatch-picker> -->
         

          <!-- <template is="dom-repeat" items="{{designImages}}">
            <template is="dom-repeat" items="{{_attachmentKeys(item._attachments)}}" as="attachment">
              <img src="http://rebelcricket.lacuna.club:5984/cats/{{item._id}}/{{ attachment }}" height="50" width="50">
            </template>
          </template>
          <br> -->

          
   
    </div>

 <!--    <hr>
    <br> -->
    <!-- <rebelcricket-design></rebelcricket-design> -->

  </template>

  <script>

  Polymer({
    is: 'rebelcricket-quote',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      services: {
        type: Array,
        notify: false,
        value: function(){
          return [ 
            { name: "Apparel", value: "apparel"}, 
            { name: "Parts Printing", value: "parts-printing"}, 
            { name: "Flatstock", value: "flatstock"}, 
            { name: "Buttons", value: "buttons"}, 
            { name: "Vinyl Lettering", value: "vinyl-lettering"}, 
            { name: "Other Stuff", value: "other"}
          ];
        }

      },
      order: {
        type: Object,
        notify: true,
        observer: '_orderObserver',
        value: function() {
          return orderModel;
        }
      },
      orderID: {
        type: String,
        notify: false,
        value: function() { 
          if(window.location.hash === ''){
            window.location.hash = generateGUID();
          }
          return window.location.hash.replace(/#/,'');
        }
      },
      dateNeeded: {
        type: Date,
        notify: true,
        observer: '_orderNeedByDateObserver'
      },
      now: {
        type: Date,
        notify: true,
        value: function(){
          return new Date;
        }
      }, 
      addServiceButtonText: {
        type: String,
        notify: true,
        computed: '_addServiceButtonText(order.services)'
      }
    },
    _orderNeedByDateObserver: function(e){
      this.set('order.date_needed', this._formatDate(this.dateNeeded));
    },
    _formatDate: function(date){
      return date.getFullYear() + "-" + ("0"+(date.getMonth() + 1)).slice(-2) + "-" + ("0"+date.getDate()).slice(-2);
    },
    _serviceSelected: function(e){
      // this.push('order.services', {name: this.services[e.target.selected].name, value: e.target.selected });
      console.log('e.model.orderService',e.model.orderService);
      e.model.set('orderService', {name: this.services[e.target.selected].name, value:  e.target.selected});
    },
    _isApparelService: function(orderService){
      return orderService.name.match(/apparel/i); 
    },
    _openDatePicker: function(e){
      console.log('_openDatePicker');
      this.$.dateNeededPicker.open();
    },
    _addAnotherService: function(e){
      console.log('ADD ANOTHER SERVICE!');
      this.push('order.services', {name: '', value: undefined });
    },
    _removeService: function(e){
      this.splice('order.services', this.order.services.indexOf(e.model.orderService), 1);
    },
    _addServiceButtonText: function(_order_services){
      if(_order_services && _order_services.length > 0){
        return 'Add another service';
      }else{
        return 'Add a service';
      }
    },
    _orderObserver: function(_order){
      try{
        _.each(_order.line_items.items, function(item){
          _.where(item, {key: 'line_total'})[0].value = _.reduce(_.where(item, {sum: true}), function(memo, v){ return memo + (v.value != undefined && v.value != '' ? parseInt(v.value) : 0); }, 0);
        });
      }catch(err){
        //o noz!
        console.log('o noz! _orderObserver caught err:',err);
      }

    },
    _isInput: function(type){
      return type == 'text' || type == 'number';
    },
    _isTextarea: function(type){
      return type == 'textarea';
    },
    _isCheckbox: function(type){
      return type == 'checkbox';
    },
    _addLineItemRow: function(e){
      //orderModel.line_items.items[0]
      this.push('order.line_items.items',orderModel.line_item_proto); 
    },
    _removeLineItemRow: function(e){
      // this.splice(path, index, removeCount, [item1, ..., itemN])
      this.splice('order.line_items.items', this.order.line_items.items.indexOf(e.model.item), 1);
    },
    _addColorMeshPrint: function(e){
      //ugh, RTFM: https://www.polymer-project.org/1.0/docs/devguide/data-system#paths
      //An index, for example, "myArray.1" indicates the array item at position 1.
      //An opaque key, prefixed with the pound sign (#), for example, "myArray.#1" indicates the array item with the key "1".
      this.push('order.graphic.items.'+e.model.index+'.color_mesh_print', orderModel.graphic.items[0].color_mesh_print[0]);
    },
    _addNewGraphic: function(e){
      this.push('order.graphic.items', orderModel.graphic.items[0]);
    },
    _openDialog: function(e){
      this.$.scrolling.open();
    },
    _toggleNeedDate: function(e){ 
      if(e.target.checked){
        this._openDatePicker();
      }
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    ready: function(){

      console.log('orderModel:',orderModel);

      console.log('this.order',this.order);

      console.log('this.order.line_items.items:',this.order.line_items.items);

      //file upload
      //rebelcricket.lacuna.club
      var db = new PouchDB('http://rebelcricket.lacuna.club:5984/orders');

      var input = this.$.orderDesignFile;
      var _this = this;
      input.addEventListener('change', function () {
        var file = input.files[0]; // file is a Blob

        db.putAttachment(_this.orderID, file.name, file, file.type).then(function (result) {
          // handle result
          
        }).catch(function (err) {
          console.log(err);
        });

      });

    }


  });


  </script>
</dom-module>
