<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">

<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="rebelcricket-icons.html">
<link rel="import" href="rebelcricket-vendor.html">

<script src="util.js"></script>
<script src="models.js"></script>
<script src="underscore-min.js"></script>

<dom-module id="rebelcricket-quote">
  <template>
    <style is="custom-style" include="shared-styles">    
      :host {
        font-size: 16px;
        --primary-color: red;
        --default-primary-color: red;
      }

      paper-button.custom, paper-fab.custom {
        background: rgba(255,0,0,0.8);
        
        margin: 1em;
        display: inline-block;
      }

      paper-button.custom:hover, paper-fab.custom:hover {
        background: red;
        color: black;
      }

      paper-icon-button:hover {
        color: red;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-input, paper-textarea {
        width: 100%;
        --paper-input-container-color: black;
        --paper-input-container-input-color: black;
      }

      paper-menu {
        --paper-menu-selected-item: {
          color: red;
        }
      }

      paper-menu-button {
        padding: 0;
      }

      hr {
        width: 97%;
      }

      .section-label {
        justify-content: center;
        font-size: 20px;
        font-weight: 100;
        text-transform: uppercase;
        width: 100%;
        background-color: #333;
        border-radius: 5px;
        margin-bottom: 1em;
      }
      .section-label span{
        color: white;
        height: 1.5em;
        text-align: center;
        padding-left: 0.5em;
        padding-right: 0.5em;
      }
      .rebel-font{
        font-family: 'ObelixPro';
        font-weight: 100;
        font-size: 2em;
        line-height: 1em;
      }

      .center{
        text-align: center;
        justify-content: center;
        width: 100%;
      }

      .group{
        border: thin solid #666;
        border-radius: 5px;

      }

      .serviceItems paper-icon-button {
        margin-top: 10px;
      }

      .apparelRow, .serviceGroup {
        border-bottom: thin dotted #ccc;
      }

      @media (max-width: 600px) {
        .section-label span{
       
          height: auto;
          padding: 0 2px 0 2px;
        }
      }

      @media (max-width: 875px) {
        .section-label span{
          height: auto;
        }
      }


    </style>

    <app-pouchdb-conflict-resolution
      strategy="lastWriteWins">
    </app-pouchdb-conflict-resolution>

    <app-pouchdb-document
      db-name="http://rebelcricket.lacuna.club:5984/orders"
      doc-id="{{orderID}}"
      data="{{order}}">
    </app-pouchdb-document>
  
    <app-pouchdb-document
      db-name="vendorItem"
      doc-id="{{orderID}}"
      data="{{vendorItem}}">
    </app-pouchdb-document>
    

    <paper-dialog id="scrolling">
      <paper-dialog-scrollable>
        <rebelcricket-vendor line-item="{{lineItemForVendor}}" order-id="{{orderID}}"></rebelcricket-vendor>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button class="custom">I don't know</paper-button>
        <paper-button class="custom">Something else</paper-button>
      </div>
    </paper-dialog>

    <div class="">
     <!--  <header class="center">
        <h1 class="rebelcricket-header">Order</h1>
      </header> -->

      <div class="row">
        <div class="col s12 center">
          <h1 class="rebel-heading">Quote</h1>
        </div>
      </div>


      <div class="">
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>[[order.client_contact_information.label]]</span>
              </div>
              <template is="dom-repeat" items="{{order.client_contact_information.items}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>
          </div>
          
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Services</span>
              </div>
              
              
              <template is="dom-repeat" items="{{order.services}}" as="orderService">
                <div class="row group">
                  <div class="row serviceGroup">
                    <div class="col s10 center">
                      <paper-dropdown-menu label="Service" on-iron-select="_serviceSelected">
                        <paper-listbox class="dropdown-content" selected="[[orderService.value]]">
                          <template is="dom-repeat" items="{{services}}">
                            <paper-item value="[[item.value]]" disabled$=[[_serviceNeedsDisabled(item.name)]]>[[item.name]]</paper-item>
                          </template>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                    <div class="col s2">
                      <paper-icon-button icon="remove" on-tap="_removeService"></paper-icon-button>
                      <small>remove</small>
                      <paper-tooltip>Remove Service</paper-tooltip>

                    </div>
                  </div>

                  <div class="serviceItems col s12 center">
                    <template is="dom-if" if="[[_isApparelService(orderService)]]">
                      <template is="dom-repeat" items="{{order.line_items.items}}" as="lineItem">
                        <div class="col s12 apparelRow">
       
                          <div class="col s2">
        
                            <paper-icon-button icon="shopping-basket" on-tap="_openDialog"></paper-icon-button>
                            <small>browse</small>

                          </div>

                          <template is="dom-repeat" items="{{lineItem.brand_style_color}}">
                            <div class$="col [[item.col]]">
                              <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                            </div>
                          </template>

                          <div class="col s2">
                            <paper-menu-button ignore-select>
                              <paper-icon-button icon="add" class="dropdown-trigger"></paper-icon-button>
                              <paper-menu class="dropdown-content" selected-values="{{lineItem.selected_sizes}}" multi>
                                <template is="dom-repeat" items="[[lineItem.apparel_sizes]]">
                                  <paper-item>[[item]]</paper-item>
                                </template>
                              </paper-menu>
                            </paper-menu-button>
                            <small>select sizes</small>
                          </div>
                          
                          <div class="col s2">
                            <paper-icon-button icon="remove" on-tap="_removeLineItemRow"></paper-icon-button>
                            <small>remove</small>
                            <paper-tooltip>Remove Textile</paper-tooltip>
                          </div>

                          <div class="col s12">
                            <template is="dom-repeat" items="{{lineItem.size_quantity}}">
                              <div class$="col [[item.col]]">
                                <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                              </div>
                            </template>

                            <template is="dom-if" if="[[lineItem.line_total]]">
                              <div class$="col [[lineItem.line_total.col]]">
                                <paper-input name="[[lineItem.line_total.key]]" label="[[lineItem.line_total.label]]" value="{{lineItem.line_total.value}}" readonly="true"></paper-input>
                              </div>
                            </template>

                          </div>
                        </div>

                      </template>
                      
                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addApparelLineItemRow">Add another textile</paper-button>
                      </div>

                    </template>
                  </div>
                  
                </div>
              </template>
             

              <div class="col s12 center">
                <paper-button class="custom" on-tap="_addAnotherService">[[addServiceButtonText]]</paper-button>
              </div>

            </div>

          </div>
          

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Graphics</span>
              </div>  
            </div>
            


            <div class="col s4">
             
              <template is="dom-repeat" items="{{_attachmentKeys(order._attachments)}}" as="attachment">
              <!-- rebelcricket.lacuna.club -->
                <img src="http://localhost:5984/cats/{{item._id}}/{{ attachment }}" height="50" width="50">
              </template>
          
              <br>
            </div>

            <div class="col s8">

              <label for="orderDesignFile">Add Image</label>
              <input id="orderDesignFile" type="file"></input>
            </div>



          </div>

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Other</span>
              </div>

              <div class="col s8">
                <paper-dialog id="dateNeededPicker" class="paper-date-picker-dialog" modal>
                  <paper-date-picker id="picker" date="{{dateNeeded}}" min-date="[[now]]"></paper-date-picker>
                  <div class="buttons">
                    <paper-button class="custom" dialog-confirm>Done</paper-button>
                  </div>
                </paper-dialog>
                
                <paper-toggle-button class="red" on-tap="_toggleNeedDate" checked="{{order.need_by_date}}">Do you need this by a certain date?</paper-toggle-button>
              
              </div>

              <div class="col s4">
                <template is="dom-if" if="[[order.need_by_date]]">
                <span id="needsDateContainer">
                  [[order.date_needed]]
                  <paper-fab mini on-tap="_openDatePicker" icon="calendar" class="custom"></paper-fab>
                  <paper-tooltip>Pick Date</paper-tooltip>
                </span>
                </template>
              </div>

              <div class="col s12">
                <paper-textarea rows="4" label="Notes" value="{{order.notes}}"></paper-textarea>
                <small>Please add any additional information or questions.</small>
              </div>

            </div>
          </div>
          
      </div>

          
   
    </div>

  </template>

  <script>

  Polymer({
    is: 'rebelcricket-quote',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      services: {
        type: Array,
        notify: false,
        value: function(){
          return [ 
            { name: "Apparel", value: "apparel"}, 
            { name: "Parts Printing", value: "parts-printing"}, 
            { name: "Flatstock", value: "flatstock"}, 
            { name: "Buttons", value: "buttons"}, 
            { name: "Vinyl Lettering", value: "vinyl-lettering"}, 
            { name: "Other Stuff", value: "other"}
          ];
        }
      },
      order: {
        type: Object,
        notify: true,
        observer: '_orderObserver',
        value: function() {
          return quoteModel;
        }
      },
      orderID: {
        type: String,
        notify: false,
        value: function() { 
          if(window.location.hash === ''){
            window.location.hash = generateGUID();
          }
          return window.location.hash.replace(/#/,'');
        }
      },
      orderService: {
        type: Object,
        notify: true,
        value: function(){
          return {name: '', value: -1};
        }
      },
      sizeItems: {
        type: Array,
        notify: true,
        observer: '_sizeItemsChanged'
      },
      dateNeeded: {
        type: Date,
        notify: true,
        observer: '_orderNeedByDateObserver'
      },
      lineItemForVendor: {
        type: Object,
        notify: true,
        observer: '_lineItemForVendorObserver'
      },
      lineItemIdxForVendor:{
        type: Number,
        notify: true
      },
      vendorItem: {
        type: Object,
        notify: true,
        observer: '_vendorItemObserver'
      },
      now: {
        type: Date,
        notify: true,
        value: function(){
          return new Date;
        }
      }, 
      addServiceButtonText: {
        type: String,
        notify: true,
        computed: '_addServiceButtonText(order.services)'
      }
    },
    _orderNeedByDateObserver: function(e){
      this.set('order.date_needed', this._formatDate(this.dateNeeded));
    },
    _formatDate: function(date){
      return date.getFullYear() + "-" + ("0"+(date.getMonth() + 1)).slice(-2) + "-" + ("0"+date.getDate()).slice(-2);
    },
    _serviceSelected: function(e){
      // this.push('order.services', {name: this.services[e.target.selected].name, value: e.target.selected });
      // console.log('e.target.selected:',e.target.selected);
      e.model.set('orderService', {name: this.services[e.target.selected].name, value:  e.target.selected});
      if(e.target.selected == 0 && this.order.line_items.items.length == 0){
        this._addApparelLineItemRow();
      }
    },
    _serviceNeedsDisabled: function(orderService){
      return _.where(this.order.services, {name: orderService}).length > 0;
    },
    _isApparelService: function(orderService){
      return orderService.name.match(/apparel/i); 
    },
    _sizeItemsChanged: function(){
      console.log('_sizeItemsChanged this.sizeItems:',this.sizeItems);
    },
    _openDatePicker: function(e){
      console.log('_openDatePicker');
      this.$.dateNeededPicker.open();
    },
    _addAnotherService: function(e){
      console.log('ADD ANOTHER SERVICE!');
      this.push('order.services', {name: '', value: undefined });
    },
    _removeService: function(e){
      
      if(this.order.services[e.model.index].name == 'Apparel'){
        console.log('REMOVING APPAREL LINE ITEMS! _removeService e.model:',e.model.index);
        this.set('order.line_items.items', []);
      }

      console.log('removeService idx: ',this.order.services.indexOf(e.model.orderService));
      this.splice('order.services', e.model.index, 1);

    },
    _addServiceButtonText: function(_order_services){
      if(_order_services && _order_services.length > 0){
        return 'Add another service';
      }else{
        return 'Add a service';
      }
    },
    _orderObserver: function(_order){
      try{
        console.log('QUOTE _orderObserver, _order:',_order);

        _.each(_order.line_items.items, function(item){
          if(item.service_type == 'Apparel'){
            if(item.selected_sizes.length != item.size_quantity.length){
              // console.log('different sizes selected, need to adjust .apparel_sizes!');
              var _sizes = _.map(item.selected_sizes, function(size){return item.apparel_sizes[size]; });
              // console.log('have sizes:', _sizes );

              _size_quantity = [];
              _.each(_sizes, function(size){
                if(_.where(item.size_quantity, {key: size}).length > 0){
                  _size_quantity.push(_.where(item.size_quantity, {key: size})[0]);
                }else{
                  var _size_proto = quoteModel.apparel_size_quantity_proto;
                  _size_proto.key = size;
                  _size_proto.label = size;
                  _size_quantity.push(_size_proto);
                }
              });
              if(_size_quantity.length > 0){
                item.line_total = quoteModel.line_item_apparel_total_proto.line_total;
              }else{
                item.line_total = undefined;
              }
              item.size_quantity = _size_quantity;
            } // if item.selected_sizes.length != item.size_quantity.length

            item.line_total.value = _.reduce(_.where(item.size_quantity, {sum: true}), function(memo, v){ return memo + (v.value != undefined && v.value != '' ? parseInt(v.value) : 0); }, 0);

          }// if item.service_type == 'Apparel'
        });
      }catch(err){
        //o noz!
        console.log('o noz! _orderObserver caught err:',err);
      }
    },
    _isInput: function(type){
      return type == 'text' || type == 'number';
    },
    _isTextarea: function(type){
      return type == 'textarea';
    },
    _isCheckbox: function(type){
      return type == 'checkbox';
    },
    _addApparelLineItemRow: function(){
      var _li_proto = quoteModel.line_item_apparel_proto;
      this.push('order.line_items.items',_li_proto); 
      //this.push('order.line_items.items',quoteModel.line_item_apparel_total_proto);
    },
    _removeLineItemRow: function(e){
      // this.splice(path, index, removeCount, [item1, ..., itemN])
      console.log('removeService idx: ',e.model.index );
      this.splice('order.line_items.items', e.model.index, 1);
    },
    _addColorMeshPrint: function(e){
      //ugh, RTFM: https://www.polymer-project.org/1.0/docs/devguide/data-system#paths
      //An index, for example, "myArray.1" indicates the array item at position 1.
      //An opaque key, prefixed with the pound sign (#), for example, "myArray.#1" indicates the array item with the key "1".
      this.push('order.graphic.items.'+e.model.index+'.color_mesh_print', quoteModel.graphic.items[0].color_mesh_print[0]);
    },
    _addNewGraphic: function(e){
      this.push('order.graphic.items', quoteModel.graphic.items[0]);
    },
    _openDialog: function(e){
      console.log('need to set li, do we have it? e.model.lineItem',e.model.lineItem);
      this.set('lineItemForVendor', e.model.lineItem);
      this.set('lineItemIdxForVendor', e.model.index);
      this.set('vendorItem.exit', false);
      this.set('vendorItem.colorsSelected', {});
      this.$.scrolling.open();
    },
    _toggleNeedDate: function(e){ 
      if(e.target.checked){
        this._openDatePicker();
      }
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    _vendorItemObserver: function(_vendorItem){
      console.log('QUOTE _vendorItemObserver _vendorItem:',_vendorItem);
      if(_vendorItem.exit){
        console.log('QUOTE vendorItem exit!!! _vendorItem.exit:',_vendorItem.exit);
        this.$.scrolling.close();

        var _lineItem = this.order.line_items.items[this.lineItemIdxForVendor]; 

        console.log('quote lineItemIdxForVendor:',this.lineItemIdxForVendor,' _lineItem:',_lineItem);
        _lineItem.brand_style_color[0].value = _vendorItem.product.brand;
        _lineItem.brand_style_color[1].value = _vendorItem.product.style;
        _lineItem.brand_style_color[2].value = Object.keys(_vendorItem.colorsSelected).join(", ");

        // this.set('lineItemForVendor.brand_style_color.0.value',  = _vendorItem.brand);
        // this.set('lineItemForVendor.brand_style_color.1.value', _vendorItem.style);
        // this.set('lineItemForVendor.brand_style_color.2.value', Object.keys(_vendorItem.colorsSelected).join(", "));

        this.set('order.line_items.items.'+this.lineItemIdxForVendor, _lineItem);
      }
    },
    _lineItemForVendorObserver: function(_lineItem){
      console.log('QUOTE _lineItemForVendorObserver _lineItem:',_lineItem);
    },
    ready: function(){

      console.log('quoteModel:',quoteModel);

      console.log('this.order',this.order);

      console.log('this.order.line_items.items:',this.order.line_items.items);

      //file upload
      //rebelcricket.lacuna.club
      var db = new PouchDB('http://rebelcricket.lacuna.club:5984/orders');

      var input = this.$.orderDesignFile;
      var _this = this;
      input.addEventListener('change', function () {
        var file = input.files[0]; // file is a Blob

        db.putAttachment(_this.orderID, file.name, file, file.type).then(function (result) {
          // handle result
          
        }).catch(function (err) {
          console.log(err);
        });

      });

    }


  });


  </script>
</dom-module>
