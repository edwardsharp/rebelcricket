<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">

<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="rebelcricket-icons.html">
<link rel="import" href="rebelcricket-vendor.html">

<script src="util.js"></script>
<script src="models.js"></script>
<script src="underscore-min.js"></script>
<script src="rgbquant.js"></script>

<dom-module id="rebelcricket-quote">
  <template>
    <style is="custom-style" include="shared-styles">    
      :host {
        font-size: 16px;
        --primary-color: red;
        --default-primary-color: red;
      }

      paper-button.custom, paper-fab.custom {
        background: rgba(255,0,0,0.8);
        
        margin: 1em;
        display: inline-block;
      }

      paper-button.custom:hover, paper-fab.custom:hover {
        background: red;
        color: black;
      }

      paper-icon-button:hover {
        color: red;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-input, paper-textarea {
        width: 100%;
        --paper-input-container-color: black;
        --paper-input-container-input-color: black;
      }

      paper-menu {
        --paper-menu-selected-item: {
          color: red;
        }
      }

      paper-menu-button {
        padding: 0;
      }

      hr {
        width: 97%;
      }

      .section-label {
        justify-content: center;
        font-size: 20px;
        font-weight: 100;
        text-transform: uppercase;
        width: 100%;
        background-color: #333;
        border-radius: 5px;
        margin-bottom: 1em;
      }
      .section-label span{
        color: white;
        height: 1.5em;
        text-align: center;
        padding-left: 0.5em;
        padding-right: 0.5em;
      }
      .rebel-font{
        font-family: 'ObelixPro';
        font-weight: 100;
        font-size: 2em;
        line-height: 1em;
      }

      .center{
        text-align: center;
        justify-content: center;
        width: 100%;
      }

      .group{
        border: thin solid #666;
        border-radius: 5px;

      }

      .serviceItems paper-icon-button {
        margin-top: 10px;
      }

      .apparelRow, .serviceGroup {
        border-bottom: thin dotted #ccc;
      }

      .graphicItems{
        border: thin solid #666;
        border-radius: 5px;
        padding: 10px;
      }

      .needsDateToggle {
        margin-top: 25px;
      }

      @media (max-width: 600px) {
        .section-label span{
       
          height: auto;
          padding: 0 2px 0 2px;
        }
      }

      @media (max-width: 875px) {
        .section-label span{
          height: auto;
        }
      }


    </style>

    <app-pouchdb-conflict-resolution
      strategy="lastWriteWins">
    </app-pouchdb-conflict-resolution>

    <app-pouchdb-document
      db-name="http://rebelcricket.lacuna.club:5984/quotes"
      doc-id="{{quoteID}}"
      data="{{quote}}">
    </app-pouchdb-document>
  
    <app-pouchdb-document
      db-name="vendorItem"
      doc-id="{{quoteID}}"
      data="{{vendorItem}}">
    </app-pouchdb-document>

    <paper-dialog id="scrolling">
      <paper-dialog-scrollable>
        <rebelcricket-vendor line-item="{{lineItemForVendor}}" quote-id="{{quoteID}}"></rebelcricket-vendor>
      </paper-dialog-scrollable>
      <!-- <div class="buttons">
        <paper-button class="custom">I don't know</paper-button>
        <paper-button class="custom">Something else</paper-button>
      </div> -->
    </paper-dialog>

    <div>

      <div class="row">
        <div class="col s12 center">
          <h1 class="rebel-heading">Quote</h1>
        </div>
      </div>


      <div class="">
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>[[quote.client_contact_information.label]]</span>
              </div>
              <template is="dom-repeat" items="{{quote.client_contact_information.items}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>
          </div>
          
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Services</span>
              </div>
              
              
              <template is="dom-repeat" items="{{quote.services}}" as="quoteServiceItem">
                <div class="row group">
                  <div class="row serviceGroup">
                    <div class="col s6 center">
                      <paper-dropdown-menu label="Service" on-iron-select="_serviceSelected">
                        <paper-listbox class="dropdown-content" selected="{{quoteServiceItem.value}}">
                          <template is="dom-repeat" items="{{services}}">
                            <paper-item value="[[item.value]]" disabled$=[[_serviceNeedsDisabled(item.name)]]>[[item.name]]</paper-item>
                          </template>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                    <div class="col s4 center">
                      <template is="dom-if" if="[[_isApparelService(quoteServiceItem)]]">
                        <small>Items Total:</small>
                        <h5>[[quoteServiceItem.total]] $[[quoteServiceItem.total_price]]</h5>
                      </template>
                    </div>
                    <div class="col s2">
                      <paper-icon-button icon="remove" on-tap="_removeService"></paper-icon-button>
                      <small>remove</small>
                      <paper-tooltip>Remove Service</paper-tooltip>

                    </div>
                  </div>

                  <div class="serviceItems col s12 center">
   
                    <template is="dom-if" if="[[_isApparelService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.line_items.items}}" as="lineItem">
                        <div class="col s12 apparelRow">
       
                          <div class="col s2">
        
                            <paper-icon-button icon="shopping-basket" on-tap="_openDialog"></paper-icon-button>
                            <small>browse</small>

                          </div>

                          <template is="dom-repeat" items="{{lineItem.brand_style_color}}">
                            <div class$="col [[item.col]]">
                              <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                            </div>
                          </template>

                          <div class="col s2">
                            <paper-menu-button ignore-select>
                              <paper-icon-button icon="add" class="dropdown-trigger"></paper-icon-button>
                              <paper-menu class="dropdown-content" selected-values="{{lineItem.selected_sizes}}" multi>
                                <template is="dom-repeat" items="[[lineItem.apparel_sizes]]">
                                  <paper-item>[[item]] [[_priceForSize(lineItem, item)]]</paper-item>
                                </template>
                              </paper-menu>
                            </paper-menu-button>
                            <small>select sizes</small>
                          </div>
                          
                          <div class="col s2">
                            <paper-icon-button icon="remove" on-tap="_removeLineItemRow"></paper-icon-button>
                            <small>remove</small>
                            <paper-tooltip>Remove Textile</paper-tooltip>
                          </div>

                          <div class="col s12">
                            <template is="dom-repeat" items="{{lineItem.size_quantity}}">
                              <div class$="col [[item.col]]">
                                <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input><small>[[item.total]]</small>
                              </div>
                            </template>

                            <template is="dom-if" if="[[lineItem.line_total]]">
                              <div class$="col [[lineItem.line_total.col]]">
                                <paper-input name="[[lineItem.line_total.key]]" label="[[lineItem.line_total.label]]" value="{{lineItem.line_total.value}}" readonly="true"></paper-input>
                                <small>$[[lineItem.line_total.total]]</small>
                              </div>
                            </template>

                          </div>
                        </div>

                      </template>
                      
                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addApparelLineItemRow">Add another textile</paper-button>
                      </div>

                    </template>
                    <div class="col s12 center">

                      <paper-textarea label="Notes" value="{{quoteServiceItem.serviceNotes}}"></paper-textarea>
                      <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                    </div>

                  </div>
                  
                </div>
              </template>
             

              <div class="col s12 center">
                <paper-button class="custom" on-tap="_addAnotherService">[[addServiceButtonText]]</paper-button>
              </div>

            </div>

          </div>
          

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Graphics</span>
              </div>  
            </div>
            


            <div class="col s12 m6 offset-m3">
             
              <template is="dom-repeat" items="{{quote.graphic.items}}">
                <div class="row graphicItems">
                  <div class="col s3">
                    <!-- localhost rebelcricket.lacuna.club -->
                    <!-- http://localhost:5984/quotes/[[quoteID]]/[[item.attachment_id]] -->
                    <a on-tap="_getPaletteInfo">
                      <img src="http://rebelcricket.lacuna.club:5984/quotes/[[quoteID]]/[[item.attachment_id]]" class="responsive-img quoteDesignImg" crossOrigin="Anonymous">
                    </a>
                  </div>

                  <div class="col s4 m3">
                    <paper-dropdown-menu label="Print This On..." ignore-select="true">
                      <paper-listbox class="dropdown-content" selected-values="{{item.print_on_items}}" multi>
                        <template is="dom-repeat" items="{{_printOnItems()}}">
                          <paper-item value="[[item]]">[[item]]</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                  </div>
                  
                  <div class="col s4 m3">
                    <paper-dropdown-menu label="Position" ignore-select>
                      <paper-listbox class="dropdown-content" selected-values="{{item.print_positions}}" multi>
                        <template is="dom-repeat" items="{{positions}}">
                          <paper-item value="[[item]]">[[item]]</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                  </div>

                  <div class="col s4 m3">

                    <paper-dropdown-menu label="Number of Colors" on-iron-select="_numColorsChanged">
                      <paper-listbox class="dropdown-content" selected="{{item.num_colors}}">
                        <template is="dom-repeat" items="{{numColors}}">
                          <paper-item value="[[item]]">&nbsp;&nbsp;[[item]]&nbsp;&nbsp;</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>

                  </div>
           
                  <template is="dom-repeat" items="{{item.colors}}" as="color">
                    <div class="col s4 m3">
                      <paper-input name="color" label="Ink Color" value="{{color}}" style$="background-color:rgba([[color]]);"></paper-input>
                    </div>
                  </template>
               
                  <div class="row">
                    <div class="col s12">
                      <paper-checkbox checked={{item.needs_white_base}}>
                          &nbsp; Needs white base
                      </paper-checkbox>
                      <small>Note: to get vibrant colors printed on dark textiles, it's recommended to first apply a layer of white ink. </small>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col s12">
                      <paper-textarea rows="2" label="Graphic Notes" value="{{item.notes}}"></paper-textarea>
                      <small>Please add any additional information about this graphic.</small>
                    </div>
                  </div>

                </div>
              </template>
          
              <br>
            </div>

            <div class="col s12 m6 offset-m3">

              <label for="quoteDesignFile">&nbsp;Upload Image file</label>
              <input id="quoteDesignFile" type="file"></input>
            </div>



          </div>

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Other</span>
              </div>

              <div class="col s8">
                <paper-dialog id="dateNeededPicker" class="paper-date-picker-dialog" modal>
                  <paper-date-picker id="picker" date="{{dateNeeded}}" min-date="[[now]]"></paper-date-picker>
                  <div class="buttons">
                    <paper-button class="custom" dialog-confirm>Done</paper-button>
                  </div>
                </paper-dialog>
                
                <paper-toggle-button class="red needsDateToggle" on-tap="_toggleNeedDate" checked="{{quote.need_by_date}}">Do you need this by a certain date?</paper-toggle-button>
              
              </div>

              <div class="col s4">
                <template is="dom-if" if="[[quote.need_by_date]]">
                <span id="needsDateContainer">
                  [[quote.date_needed]]
                  <paper-fab mini on-tap="_openDatePicker" icon="calendar" class="custom"></paper-fab>
                  <paper-tooltip>Pick Date</paper-tooltip>
                </span>
                </template>
              </div>

              <div class="col s12">
                <paper-textarea rows="4" label="Notes" value="{{quote.notes}}"></paper-textarea>
                <small>Please add any additional information or questions.</small>
              </div>

            </div>
          </div>
          

          <div class="row">
            <div class="col s12 m6 offset-m3 center">

              <paper-button class="custom" on-tap="_submitQuote">Submit Quote</paper-button>

            </div>
          </div>

      </div>

          
   
    </div>

  </template>

  <script>

  Polymer({
    is: 'rebelcricket-quote',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      services: {
        type: Array,
        notify: false,
        value: function(){
          return [ 
            { name: "Apparel", value: "apparel"}, 
            { name: "Parts Printing", value: "parts-printing"}, 
            { name: "Flatstock", value: "flatstock"}, 
            { name: "Buttons", value: "buttons"}, 
            { name: "Vinyl Lettering", value: "vinyl-lettering"}, 
            { name: "Other Stuff", value: "other"}
          ];
        }
      },
      quote: {
        type: Object,
        notify: true,
        observer: '_quoteObserver',
        value: function() {
          return quoteModel;
        }
      },
      quoteID: {
        type: String,
        notify: false,
        value: function() { 
          if(window.location.hash === ''){
            window.location.hash = generateGUID();
          }
          return window.location.hash.replace(/#/,'');
        }
      },
      sizeItems: {
        type: Array,
        notify: true,
        observer: '_sizeItemsChanged'
      },
      dateNeeded: {
        type: Date,
        notify: true,
        observer: '_quoteNeedByDateObserver'
      },
      lineItemForVendor: {
        type: Object,
        notify: true,
        observer: '_lineItemForVendorObserver'
      },
      lineItemIdxForVendor:{
        type: Number,
        notify: true
      },
      vendorItem: {
        type: Object,
        notify: true,
        observer: '_vendorItemObserver'
      },
      numColors: {
        type: Array,
        notify: false,
        value: function(){
          return Array.apply(null, {length: 20}).map(Number.call, Number);
        }
      },
      positions: {
        type: Array,
        notify: false,
        value: function(){
          return [
            "Front Center",
            "Front Left",
            "Front Right",
            "Back Center",
            "Back Lower",
            "Left Sleeve",
            "Right Sleeve",
            "Not Sure",
            "Other (please describe)"
          ]
        }
      },
      now: {
        type: Date,
        notify: true,
        value: function(){
          return new Date;
        }
      }, 
      addServiceButtonText: {
        type: String,
        notify: true,
        computed: '_addServiceButtonText(quote.services)'
      }
    },
    _quoteNeedByDateObserver: function(e){
      this.set('quote.date_needed', this._formatDate(this.dateNeeded));
    },
    _formatDate: function(date){
      return date.getFullYear() + "-" + ("0"+(date.getMonth() + 1)).slice(-2) + "-" + ("0"+date.getDate()).slice(-2);
    },
    _serviceSelected: function(e){
      // this.push('quote.services', {name: this.services[e.target.selected].name, value: e.target.selected });
      // console.log('e.target.selected:',e.target.selected);
      // console.log('_serviceSelected!');
      e.model.set('quoteServiceItem', {name: this.services[e.target.selected].name, value:  e.target.selected});
      if(e.target.selected == 0 && this.quote.line_items.items.length == 0){ //
        // console.log('!!! _serviceSelected, gonna _addApparelLineItemRow()');
        this._addApparelLineItemRow();
      }
    },
    _serviceNeedsDisabled: function(quoteService){
      return _.where(this.quote.services, {name: quoteService}).length > 0;
    },
    _isApparelService: function(quoteService){
      return quoteService.name.match(/apparel/i); 
    },
    _isOtherService: function(quoteService){
      return quoteService.name != undefined && quoteService.name != '' && !quoteService.name.match(/apparel/i);
    },
    _sizeItemsChanged: function(){
      // console.log('_sizeItemsChanged this.sizeItems:',this.sizeItems);
    },
    _openDatePicker: function(e){
      // console.log('_openDatePicker');
      this.$.dateNeededPicker.open();
    },
    _addAnotherService: function(e){
      // console.log('ADD ANOTHER SERVICE!');
      this.push('quote.services', {name: '', value: undefined });
    },
    _removeService: function(e){
      
      if(this.quote.services[e.model.index].name == 'Apparel'){
        // console.log('REMOVING APPAREL LINE ITEMS! _removeService e.model:',e.model.index);
        this.set('quote.line_items.items', []);
      }

      // console.log('removeService idx: ',this.quote.services.indexOf(e.model.quoteServiceItem));
      this.splice('quote.services', e.model.index, 1);

    },
    _addServiceButtonText: function(_quote_services){
      if(_quote_services && _quote_services.length > 0){
        return 'Add another service';
      }else{
        return 'Add a service';
      }
    },
    _quoteObserver: function(_quote){
      try{
        // console.log('QUOTE _quoteObserver, _quote:',_quote);

        var lineItemsTotalPrice = 0
          , lineItemsTotal = 0
        _.each(_quote.line_items.items, function(item){
          if(item.service_type == 'Apparel'){
            if(item.selected_sizes.length != item.size_quantity.length){
              // console.log('different sizes selected, need to adjust .apparel_sizes!');
              var _sizes = _.map(item.selected_sizes, function(size){return item.apparel_sizes[size]; });
              // console.log('have sizes:', _sizes );

              _size_quantity = [];
              _.each(_sizes, function(size,idx){
                if(_.where(item.size_quantity, {key: size}).length > 0){
                  _size_quantity.push(_.where(item.size_quantity, {key: size})[0]);
                }else{
                  var _size_proto = quoteModel.apparel_size_quantity_proto;
                  _size_proto.key = size;
                  _size_proto.label = size;
                  // console.log('!!!!!!!!!!!!! setting price total to:',item.prices[idx]);
                  _size_proto.total = item.prices[idx];
                  _size_quantity.push(_size_proto);
                }
              });
              if(_size_quantity.length > 0){
                item.line_total = quoteModel.line_item_apparel_total_proto.line_total;
              }else{
                item.line_total = undefined;
              }
              item.size_quantity = _size_quantity;
            } // if item.selected_sizes.length != item.size_quantity.length

            if(item.line_total != undefined){
              item.line_total.value = _.reduce(_.where(item.size_quantity, {sum: true}), function(memo, v){ return memo + (v.value != undefined && v.value != '' ? parseInt(v.value) : 0); }, 0);
              lineItemsTotal += item.line_total.value;
              try{
                item.line_total.total = _.reduce(_.where(item.size_quantity, {sum: true}), function(memo, v){ return memo + (v.total != undefined && !isNaN(parseFloat(v.total.replace(/\$/,''))) ? (v.value == undefined ? 0 : v.value) * parseFloat(v.total.replace(/\$/,'')) : 0); }, 0).toFixed(2);

                lineItemsTotalPrice += parseFloat(item.line_total.total);
                //console.log('parseFloat(v.total.replace(/\$/)', v.total.replace(/\$/,'')); console.log('v.value:',v.value);
                // console.log('zomg, item.line_total.total:',item.line_total.total);

              }catch(err){
                //o noz!
              }
              
            }
            

          }// if item.service_type == 'Apparel'
        });

        if(lineItemsTotalPrice > 0){
          var _li = _.where(this.quote.services, {name: "Apparel"})[0];
          if(_li){
            _li.total = lineItemsTotal;
            _li.total_price = lineItemsTotalPrice.toFixed(2);
          }
          
          // this.set('quote.line_items.items_total', lineItemsTotal);
          
        }
        // console.log('SUPA TOTAL:',lineItemsTotal,' lineItemsTotalPrice:',lineItemsTotalPrice);
      }catch(err){
        //o noz!
        console.log('o noz! _quoteObserver caught err:',err);
      }
    },
    _isInput: function(type){
      return type == 'text' || type == 'number';
    },
    _isTextarea: function(type){
      return type == 'textarea';
    },
    _isCheckbox: function(type){
      return type == 'checkbox';
    },
    _addApparelLineItemRow: function(){
      var _li_proto = quoteModel.line_item_apparel_proto;
      this.push('quote.line_items.items',_li_proto); 
      //this.push('quote.line_items.items',quoteModel.line_item_apparel_total_proto);
    },
    _removeLineItemRow: function(e){
      // this.splice(path, index, removeCount, [item1, ..., itemN])
      // console.log('removeService idx: ',e.model.index );
      this.splice('quote.line_items.items', e.model.index, 1);
    },
    _addColorMeshPrint: function(e){
      //ugh, RTFM: https://www.polymer-project.org/1.0/docs/devguide/data-system#paths
      //An index, for example, "myArray.1" indicates the array item at position 1.
      //An opaque key, prefixed with the pound sign (#), for example, "myArray.#1" indicates the array item with the key "1".
      this.push('quote.graphic.items.'+e.model.index+'.color_mesh_print', quoteModel.graphic.items[0].color_mesh_print[0]);
    },
    _addNewGraphic: function(e){
      this.push('quote.graphic.items', quoteModel.graphic.items[0]);
    },
    _openDialog: function(e){
      // console.log('need to set li, do we have it? e.model.lineItem',e.model.lineItem);
      this.set('lineItemForVendor', e.model.lineItem);
      this.set('lineItemIdxForVendor', e.model.index);
      this.set('vendorItem.exit', false);
      this.set('vendorItem.colorsSelected', {});
      this.$.scrolling.open();
    },
    _toggleNeedDate: function(e){ 
      if(e.target.checked){
        this._openDatePicker();
      }
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    _vendorItemObserver: function(_vendorItem){
      // console.log('QUOTE _vendorItemObserver _vendorItem:',_vendorItem);
      if(_vendorItem.exit){
        // console.log('QUOTE vendorItem exit!!! _vendorItem.exit:',_vendorItem.exit);
        this.$.scrolling.close();

        if(Object.keys(_vendorItem.colorsSelected).length > 0 && this.quote.line_items != undefined && this.quote.line_items.items[this.lineItemIdxForVendor] != undefined){
          
          var _lineItems = this.quote.line_items.items;
          var _lineItem = this.quote.line_items.items[this.lineItemIdxForVendor]; 
          _lineItems.splice(this.lineItemIdxForVendor, 1);

          var _this = this;
          _.each(_vendorItem.colorsSelected, function(v,k){
            var _li = JSON.parse(JSON.stringify(_lineItem)); //eek.
            _li.brand_style_color[0].value = _vendorItem.product.brand;
            _li.brand_style_color[1].value = _vendorItem.product.style;
            _li.brand_style_color[2].value = k;
            _li.apparel_sizes = v.sizes;
            _li.prices = v.prices;
            // console.log('quote k:',k,', gonna push _li',_li);
            _lineItems.push(_li);
      
          });

          this.set('quote.line_items.items', _lineItems);
          
        }
        
      }
    },
    _lineItemForVendorObserver: function(_lineItem){
      // console.log('QUOTE _lineItemForVendorObserver _lineItem:',_lineItem);
    },
    _priceForSize: function(_li, _item){
      var _itemIdx = _li.apparel_sizes.indexOf(_item);
      if(_itemIdx && _li.prices){
        return _li.prices[_itemIdx]; 
      }else{
        return '';
      }
      
    },
    _numColorsChanged: function(e){
      // this.async(function(){
        // console.log('e.model.index:',e.model.index);

        if(e.model.item.colors.length != e.target.selected){
          //this.set('e.model.item.num_colors', e.target.selected);
          
          //e.model.item.colors.length = e.target.selected;
          

            // this.set('e.model.item.colors.length', e.target.selected);
            // console.log('e.target.selected',e.target.selected);
            e.model.item.colors.length = e.target.selected;
            e.model.item.colors = Array.apply(null, e.model.item.colors).map(String.prototype.valueOf,"")
            // this.set('e.model.item.colors', Array.apply(null, e.model.item.colors).map(String.prototype.valueOf,""));

          this.notifyPath('quote.graphic.items.'+e.model.index+'.colors');
   
          // console.log('set length to:', e.target.selected);
          // console.log('and apply, now e.model.item.colors:',e.model.item.colors);
          // this.async(function(){
            
            
            // console.log('_numColorsChanged done! e.model.item.colors:',e.model.item.colors);
            // this.async(function(){
            //   this.notifyPath('e.model.item.colors');
            // }, 500);

          // }, 200);
        }
      // }, 200);

      
      
    //   // console.log('aaarg, this.quote.graphic.items[e.model.index].colors: ',this.quote.graphic.items[e.model.index].colors);
      
    },
    _printOnItems: function(){
      var _itemz = [];
      try{
        _itemz.push( _.map(this.quote.line_items.items, function(item){return _.map(item.brand_style_color, function(i){return i.value;}).join(', ');}) );
      }catch(err){
        //o noz!
      }
      _itemz.push( _.map(this.quote.services, function(serv){return 'All '+serv.name;}) );
      // console.log('_itemz:',_.flatten(_itemz));
      return _.flatten(_itemz);
    },
    _getPaletteInfo: function(e){

      // options with defaults (not required)
      var opts = {
          colors: 256,             // desired palette size
          method: 2,               // histogram method, 2: min-population threshold within subregions; 1: global top-population
          boxSize: [64,64],        // subregion dims (if method = 2)
          boxPxls: 2,              // min-population threshold (if method = 2)
          initColors: 4096,        // # of top-occurring colors  to start with (if method = 1)
          minHueCols: 0,           // # of colors per hue group to evaluate regardless of counts, to retain low-count hues
          dithKern: null,          // dithering kernel name, see available kernels in docs below
          dithDelta: 0,            // dithering threshhold (0-1) e.g: 0.05 will not dither colors with <= 5% difference
          dithSerp: false,         // enable serpentine pattern dithering
          palette: [],             // a predefined palette to start with in r,g,b tuple format: [[r,g,b],[r,g,b]...]
          reIndex: false,          // affects predefined palettes only. if true, allows compacting of sparsed palette once target palette size is reached. also enables palette sorting.
          useCache: true,          // enables caching for perf usually, but can reduce perf in some cases, like pre-def palettes
          cacheFreq: 10,           // min color occurance count needed to qualify for caching
          colorDist: "euclidean",  // method used to determine color distance, can also be "manhattan"
      };

      try{
        
        var q = new RgbQuant(opts);

        // analyze histograms
        // console.log('_getPaletteInfo selector?',this.$$('.quoteDesignImg'));
        q.sample(this.$$('.quoteDesignImg'));

        // build palette
        var pal = q.palette();
        // console.log('!! _getPaletteInfo pal:',pal);

        var _colors = [];
        var _numColors = pal.length > 60 ? 60 : pal.length;

        for (var i = 0; i < _numColors; i=i+4) {
          _colors.push( pal[i] +', '+ pal[i+1] +', '+ pal[i+2] +', '+ pal[i+3] );
        }
        this.set('quote.graphic.items.0.colors', _colors);
        this.async(function(){ this.set('quote.graphic.items.0.num_colors', (_numColors / 4).toFixed(0) ); }, 200);
        
        // reduce images
        // var outA = q.reduce(_file);

        // console.log('_getPaletteInfo _numColors:',_numColors,' _colors:',_colors);

      }catch(err){
        console.log('o noz! could not _getPaletteInfo!');
      }
      
    },
    _submitQuote: function(){
      console.log('submit quote!',new Date);
      this.set('quote.submitted', new Date);
    },
    ready: function(){

      //this initz the quote couch db doc
      var db = new PouchDB('http://rebelcricket.lacuna.club:5984/quotes');

      //file upload
      var input = this.$.quoteDesignFile;
      var _this = this;
      input.addEventListener('change', function () {
        var file = input.files[0]; // file is a Blob

        if(_this.quote._attachments == undefined){

          var attachment = {};
        
          attachment[file.name] = {
            type: file.type,
            content_type: file.type,
            data: file
          }
          _this.set('quote._attachments', attachment);
        }else{

          var attachments = _this.quote._attachments;

          attachments[file.name] = {
            type: file.type,
            content_type: file.type,
            data: file
          }
          _this.set('quote._attachments', attachments);
        }

        var graphic_item = quoteModel.graphic_item_proto;
        graphic_item.attachment_id = file.name;

        _this.async(function(){ _this.push('quote.graphic.items', graphic_item); }, 500);

      });

    }


  });


  </script>
</dom-module>
