<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<!-- <link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html"> -->

<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="rebelcricket-icons.html">
<link rel="import" href="rebelcricket-design.html">
<link rel="import" href="rebelcricket-vendor.html">

<script src="models.js"></script>
<script src="util.js"></script>
<script src="underscore-min.js"></script>

<dom-module id="rebelcricket-order">
  <template>
    <style is="custom-style" include="shared-styles">    
      :host {
        font-size: 16px;
      }
      paper-button.custom, paper-fab.custom {
        background: rgba(255,0,0,0.8);
        
        margin: 1em;
        display: inline-block;
      }

      paper-button.custom:hover, paper-fab.custom:hover {
        background: red;
       
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-input, paper-textarea {
        width: 100%;
        --paper-input-container-color: black;
        --paper-input-container-input-color: black;
      }

      hr {
        width: 97%;
      }

      .section-label {
        justify-content: center;
        font-size: 20px;
        font-weight: 100;
      }
      .section-label span{
        color: white;
        background-color: #333;
        border-radius: 5px;
        width: 97%;
        height: 1.5em;
        text-align: center;
        padding-left: 0.5em;
        padding-right: 0.5em;
      }
      .rebel-font{
        font-family: 'ObelixPro';
        font-weight: 100;
        font-size: 2em;
        line-height: 1em;
      }

      .center{
        text-align: center;
        justify-content: center;
        width: 100%;
      }

      .group{
        border: thin solid #666;
        border-radius: 5px;
        margin: 1em;
      }
      
     

      @media (max-width: 600px) {
        .section-label span{
          width: auto;
          height: auto;
          padding: 0 2px 0 2px;
        }
      }

      @media (max-width: 875px) {
        .section-label span{
          height: auto;
        }
      }


    </style>
 <!--    <app-route
        route="[[route]]"
        pattern="/:order_id"
        data="{{routeData}}"></app-route> -->

<!--     <app-pouchdb-document
      db-name="http://rebelcricket.lacuna.club:5984/models"
      doc-id="order"
      data="{{orderModel}}">
    </app-pouchdb-document> -->

    <app-pouchdb-conflict-resolution
      strategy="lastWriteWins">
    </app-pouchdb-conflict-resolution>

    <app-pouchdb-document
      db-name="http://rebelcricket.lacuna.club:5984/orders"
      doc-id="{{orderID}}"
      data="{{order}}">
    </app-pouchdb-document>
  
    

<paper-dialog id="scrolling">
  <paper-dialog-scrollable>
    <rebelcricket-vendor></rebelcricket-vendor>
  </paper-dialog-scrollable>
  <div class="buttons">
    <paper-button class="custom">I don't know</paper-button>
    <paper-button class="custom">I don't care</paper-button>
    <paper-button class="custom">Something else</paper-button>
  </div>
</paper-dialog>

    <div class="">
     <!--  <header class="center">
        <h1 class="rebelcricket-header">Order</h1>
      </header> -->

      <div class="">
          <div class="row">
            <div class="col s7">
              <template is="dom-repeat" items="{{order.header.items0}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>

            <div class="col s5">
              <template is="dom-repeat" items="{{order.header.items1}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>
          </div>
          <div class="row">

            <div class="col s7">
              <div class="col s8 rebel-font">[[order.header.label0]]</div>
              <div class="col s4 section-label"><span>[[order.header.label1]]</span></div>
            </div>
            <div class="col s5">
              <template is="dom-repeat" items="{{order.header.items2}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>
          </div>
     
          <div class="row">
            <div class="col s12 m6">
              <div class="col s12 section-label">
                <span>[[order.job.label]]</span>
              </div>
              <template is="dom-repeat" items="{{order.job.items}}">
                <div class$="col [[item.col]]">
                  <template is="dom-if" if="[[_isInput(item.type)]]">
                    <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                  </template>
                  <template is="dom-if" if="[[_isTextarea(item.type)]]">
                    <paper-textarea rows="[[item.rows]]" name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-textarea>
                  </template>
                </div>
              </template>
            </div>
            <div class="col s12 m6">
              <div class="col s12 section-label">
                <span>[[order.client_contact_information.label]]</span>
              </div>
              <template is="dom-repeat" items="{{order.client_contact_information.items}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>

            <div class="col s12 m6">
              <div class="col s12 section-label">
                <span>[[order.job_completion_and_shipping.label]]</span>
              </div>
              <br>
              <br>
              <template is="dom-repeat" items="{{order.job_completion_and_shipping.items}}">
                <div class$="col [[item.col]]">
                  <template is="dom-if" if="[[_isInput(item.type)]]">
                    <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                  </template>
                  <template is="dom-if" if="[[_isTextarea(item.type)]]">
                    <paper-textarea rows="[[item.rows]]" name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-textarea>
                  </template>
                  <template is="dom-if" if="[[_isCheckbox(item.type)]]">
                    <paper-checkbox checked="{{item.value}}"> [[item.label]]</paper-checkbox>
                  </template>
                </div>
              </template>
            </div>

          </div>
          <br>
          <div class="row">
            <template is="dom-repeat" items="{{order.line_items.items}}">
              <div class="col s12 group">
              <template is="dom-repeat" items="{{item}}">
                <div class$="col [[item.col]]">
                  <template is="dom-if" if="[[item.on_tap]]">
                    <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}" readonly$="[[item.readonly]]" on-tap="_openDialog"></paper-input>
                  </template>
                  <template is="dom-if" if="[[!item.on_tap]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}" readonly$="[[item.readonly]]"></paper-input>
                  </template>

                </div>
              </template>
              </div>
            </template>
            <div class="col s12 center">
<!--               <paper-button class="custom" on-tap="_addLineItemRow" raised>&plus;</paper-button> -->
             
                <paper-fab mini on-tap="_addLineItemRow" icon="add" class="custom"></paper-fab>
                <paper-tooltip>Add new line item row</paper-tooltip>
              
            </div>
          </div>
          <br>
          <div class="row">
            
              <template is="dom-repeat" items="{{order.graphic.items}}">
                <div class="col s12 m6 l4 graphic-group">
              
                  <template is="dom-repeat" items="{{item.top}}">
                    <div class$="col [[item.col]]">
                      <template is="dom-if" if="[[_isInput(item.type)]]">
                        <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}" readonly$="[[item.readonly]]"></paper-input>
                      </template>
                    </div>
                  </template>
      
                  <template is="dom-repeat" items="{{item.color_mesh_print}}">
                    <div class="col s12 group">
                    <template is="dom-repeat" items="{{item}}">
                      <div class$="col [[item.col]]">
                        <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
             
                      </div>
                    </template>
                    </div>
                  </template>
                  <div class="col s12 center">
                    <!-- <paper-button class="custom" on-tap="_addColorMeshPrint" raised>&plus;</paper-button> -->
                  
                      <paper-fab mini on-tap="_addColorMeshPrint" icon="add" class="custom"></paper-fab>
                      <paper-tooltip>Add new Color/Mesh/Print Order</paper-tooltip>
                 
                  </div>
                  <template is="dom-repeat" items="{{item.bottom}}">
                    <div class$="col [[item.col]]">
                      <template is="dom-if" if="[[_isInput(item.type)]]">
                        <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                      </template>
                    </div>
                  </template>
             
                </div>
              </template>

              <div class="col s12 m6 l4 center">
              <!-- <paper-button class="custom" on-tap="_addNewGraphic" raised>&plus;</paper-button> -->
              
                <paper-fab mini on-tap="_addNewGraphic" icon="add" class="custom"></paper-fab>
                <paper-tooltip>Add new Graphic</paper-tooltip>
          
            </div>
          </div>
       
          
      </div>



         <!--  <paper-dropdown-menu label="Style" on-iron-select="_styleSelected">
            <paper-listbox class="dropdown-content" selected="0">
              <paper-item value="crew">Crew</paper-item>
              <paper-item value="womens_crew">Women's Crew</paper-item>
              <paper-item value="hoodie">Hoodie</paper-item>
              <paper-item value="longsleeve">Long Sleeve</paper-item>
            </paper-listbox>
          </paper-dropdown-menu> -->
        <!--   <paper-swatch-picker color="{{designElementColor}}" column-count=4 color-list='["#000000", "#65a5f2", "#83be54", "#f0d551", "#e5943c", "#a96ddb", "#B20000", "#ffffff"]'></paper-swatch-picker> -->
         

          <!-- <template is="dom-repeat" items="{{designImages}}">
            <template is="dom-repeat" items="{{_attachmentKeys(item._attachments)}}" as="attachment">
              <img src="http://rebelcricket.lacuna.club:5984/cats/{{item._id}}/{{ attachment }}" height="50" width="50">
            </template>
          </template>
          <br> -->

          
   
    </div>

    <hr>
    <br>
    <rebelcricket-design></rebelcricket-design>

  </template>

  <script>
  Polymer({
    is: 'rebelcricket-order',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      
      order: {
        type: Object,
        notify: true,
        observer: '_orderObserver',
        value: function() {
          return orderModel;
        }
      },
      orderID: {
        type: String,
        notify: false,
        value: function() { 
          if(window.location.hash === ''){
            window.location.hash = generateID();
          }
          return window.location.hash.replace(/#/,'');
        }
      }
    },
    _orderObserver: function(_order){
      try{
        _.each(_order.line_items.items, function(item){
          _.where(item, {key: 'line_total'})[0].value = _.reduce(_.where(item, {sum: true}), function(memo, v){ return memo + (v.value != undefined && v.value != '' ? parseInt(v.value) : 0); }, 0);
        });
      }catch(err){
        //o noz!
        console.log('o noz! _orderObserver caught err:',err);
      }

    },
    _isInput: function(type){
      return type == 'text' || type == 'number';
    },
    _isTextarea: function(type){
      return type == 'textarea';
    },
    _isCheckbox: function(type){
      return type == 'checkbox';
    },
    _addLineItemRow: function(e){
      this.push('order.line_items.items',orderModel.line_items.items[0]);
    },
    _addColorMeshPrint: function(e){
      //ugh, RTFM: https://www.polymer-project.org/1.0/docs/devguide/data-system#paths
      //An index, for example, "myArray.1" indicates the array item at position 1.
      //An opaque key, prefixed with the pound sign (#), for example, "myArray.#1" indicates the array item with the key "1".
      this.push('order.graphic.items.'+e.model.index+'.color_mesh_print', orderModel.graphic.items[0].color_mesh_print[0]);
    },
    _addNewGraphic: function(e){
      this.push('order.graphic.items', orderModel.graphic.items[0]);
    },
    _openDialog: function(e){
      console.log('_openDialog e:',e);
      this.$.scrolling.open();
    },
    ready: function(){

      console.log('orderModel:',orderModel);

      console.log('this.order',this.order);

      console.log('this.order.line_items.items:',this.order.line_items.items);

      //file upload
      // var db = new PouchDB('http://rebelcricket.lacuna.club:5984/orders');

      // var input = this.$.catFile;
      // var _this = this;
      // input.addEventListener('change', function () {
      //   var file = input.files[0]; // file is a Blob

      //   db.putAttachment(this.orderID, file.name, file, file.type).then(function (result) {
      //     // handle result
      //     // _this._addImageToCanvas('http://rebelcricket.lacuna.club:5984/cats/'+file.name+'/'+file.name);
      //   }).catch(function (err) {
      //     console.log(err);
      //   });

      // });

    }


  });


  </script>
</dom-module>
