<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<!-- <link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html">  -->
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">

<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="shared-styles.html">

<script src="underscore-min.js"></script>

<dom-module id="rebelcricket-vendor">

  <template>

    <style is="custom-style" include="shared-styles">


    .container {
      width: 100%;
    }

    .left{
      width: 350px;
     
      
      overflow-x: hidden;
      overflow-y: scroll;
      padding: 1em;
    }


    .heading {
      padding: 10px 15px;
      margin-top: 20px;
      background-color: #f3f3f3;
      border: 1px solid #dedede;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      width: 100%;
      text-align: left;
    }
    .item-content {
      min-height: 80vh;
      width: 80vw;
   /*   padding: 15px;
      border: 1px solid #eeddee;
      border-top: none;
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
      @apply(--shadow-elevation-2dp);*/
    }
    .item {
      margin-bottom: 1em;
      font-size: 15px;
      line-height: 16px;
      text-align: justify;
      text-justify: inter-word;
      overflow: hidden;
      text-overflow: ellipsis;
      height: 160px;
      border-bottom: thin solid #eeddee;
    }
    .item:hover{
      color: red;
      border-color: red;
    }

    .exit-detail{
      float:left;
      margin-top: 1em;
    }

    .prod-desc-items {
      float: left;
    }

    .colors {
      float: right;
    }

    img {
      float: left;
      max-height: 200px;
      max-width: 200px;
    }


    @media (max-width: 767px) {
      
    }
    </style>


    <app-pouchdb-document
      db-name="http://localhost:5984/products"
      doc-id="companycasual.com"
      data="{{companycasual}}">
    </app-pouchdb-document>
      

    <div class="container">
      
      <template is="dom-if" if="[[!companycasual.products_by_sub_item]]">
        Loading items...
      </template>

      <template is="dom-if" if="[[isDetailView]]">
        <div class="exit-detail">
          <paper-button class="custom" on-tap="_exitDetailViewWithSelection">back</paper-button>
        </div>
      </template>

      <template is="dom-if" if="[[!isDetailView]]">
      <div class="row">

          <div class="col s6">

            <label>Filter by style</label>
            <select value="{{selectValue::change}}">
              <option selected>Select by Category</option>
              <template is="dom-repeat" items="[[_productCategories(companycasual)]]" as="category">
                <optgroup label="[[category]]">
                  <option>See All [[category]]</option>
                  <template is="dom-repeat" items="[[_productSubCategories(companycasual, category)]]" as="sub_category">
                    <option>[[sub_category]]</option>
                  </template>
                </optgroup> 
              </template>
            </select>    

          </div>
          <div class="col s6">
            <!-- search -->
          </div>
        
        </div> <!-- row -->


        <div class="item-content row center">
    
          <template is="dom-repeat" items="[[filteredProducts]]" as="product">
            
              <div class="col s12 m6 l4 item" on-tap="_itemSelected">
                <template is="dom-if" if="[[product.items.prod_id]]">
                  <img src$="http://cdn.companycasuals.com/cache/cc/[[product.items.prod_id]].jpg">
                </template>
                <div>[[product.title]]</div>
              </div>
            
          </template>

        </div>
      </template>

      <template is="dom-if" if="[[isDetailView]]">
        <div class="detail-content row center">
          
          <h5>[[selectedItem.title]]</h5>
          <h6>[[selectedItem.items.prod_id]] [[selectedItem.category]] [[selectedItem.sub_item]]</h6>

          <p>[[selectedItem.items.prod_desc_text]]</p>

          <ul class="prod-desc-items">
            <template is="dom-repeat" items="[[selectedItem.items.prod_desc_items]]">
              <li>[[item]]</li>
            </template>
          </ul>

          <div class="colors">
            <template is="dom-repeat" items="[[selectedItem.items.colors]]">
              <div class="color-img">
                <img src$="[[item.href]]">
                <small>[[item.name]]</small>
              </div>
            </template>
          </div>

        </div>

        <div class="row center">

          <paper-button class="custom" on-tap="_exitDetailViewWithSelection">Use this</paper-button>
        </div>
      </template>
    </div>
    
    
  </template>

  <script>

    Polymer({

      is: 'rebelcricket-vendor',
      // behaviors: [
      //   Polymer.AppPouchDBDatabaseBehavior
      // ],
      properties: {
        companycasual: {
          type: Object,
          notify: true
        },
        filteredProducts: {
          type: Object,
          notify: true
        },
        selectValue: {
          type: String,
          observer: '_selectObserver'
        },
        selectedItem: {
          type: Object,
          notify: true
        },
        isDetailView: {
          type: Boolean,
          notify: true,
          value: function(){
            return false;
          }
        }
      },
      _noFilteredProducts: function(){
        console.log('Object.keys(filteredProducts):',Object.keys(filteredProducts));
        return Object.keys(filteredProducts).length == 0;
      },
      _selectObserver: function(val){
        if(val && val != ''){
          console.log('_selectObserver val:',val);
          this._filterProducts(val.replace(/See All /, ''));
        }
      },
      _filterProducts: function(by_str){
        console.log('_filterProducts by_str:',by_str);
        this.set('filteredProducts', _.filter(this.companycasual.products_by_sub_item, function(item){
          return item.category == by_str || item.sub_item == by_str;
        }));
      },
      _productCategories(obj){
        return _.uniq(_.map(obj.products_by_sub_item, function(item){
          return item.category;
        }));
      },
      _productSubCategories(obj, category){
        return _.uniq(_.map(_.filter(obj.products_by_sub_item, function(item){
          return item.category == category;
        }), function(item){
          return item.sub_item;
        }));
      },
      _strip: function(str){
        return str.replace(/[^a-zA-Z0-9]/g, '');
      },
      toggle: function(e){
        console.log('e.model.item.sub_item strip:',this._strip(e.model.item.category+e.model.item.sub_item));
        try{
          this.$$('#'+this._strip(e.model.item.category+e.model.item.sub_item)).toggle();
        }catch(err){
          console.log('o noz, fuckng selector!');
        }
      },
      _itemSelected: function(e){
        console.log('e.model.product', e.model.product);
        this.set('selectedItem', e.model.product);
        this.set('isDetailView', true);
      }, 
      _exitDetailViewWithSelection: function(e){
        this.set('selectedItem', undefined);
        this.set('isDetailView', false);
        console.log('_exitDetailViewWithSelection e:',e);
      }
      

    });

  </script>

</dom-module>
