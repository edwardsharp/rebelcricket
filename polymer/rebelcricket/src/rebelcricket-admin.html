<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="shared-styles.html">


<dom-module id="rebelcricket-admin">

  <template>

    <style is="custom-style" include="shared-styles">

      .drawer-button {
        margin: 1em;
      }

      #headerToolbar {
        padding-left: 1.5em;
      }

      app-toolbar {
        padding: 0;
        
      }
      
      app-header {
        background-color: rgba(255,255,255,0.9);
      }

      paper-button.custom, paper-fab.custom {
        background: rgba(255,0,0,0.8);
        
        margin: 1em;
        display: inline-block;
      }
      paper-fab.custom {
        font-size:1.5em;
        line-height: 1em;
      }

      paper-button.custom:hover, paper-fab.custom:hover {
        background: red;
        color: black;
      }

      .rebel-image{
        max-height: 150px;
        max-width: 150px;
      }

      .description-item {
        margin: 2em;
      }

      ol, ul {
        list-style: none;
      }
      @media (max-width: 767px) {
        
      }
    </style>

    <app-pouchdb-document
      db-name="admin"
      doc-id="admin"
      data="{{admin}}">
    </app-pouchdb-document>

    <iron-ajax
      id="ajaxValidateApiKey"
      url="http://rebelcricket.lacuna.club/api/validate_api_key"
      headers='{{headers}}'
      handle-as="json"
      on-response="_handleValidateApiKeyResponse">
    </iron-ajax>

    <iron-ajax
      id="ajaxGetPages"
      url="http://rebelcricket.lacuna.club/api/all_pages"
      headers='{{headers}}'
      handle-as="json"
      last-response="{{pages}}">
    </iron-ajax>

    <iron-ajax
      id="ajaxUpdatePage"
      url="http://rebelcricket.lacuna.club/api/all_pages"
      headers='{{headers}}'
      handle-as="json"
      on-response="_handleUpdatePageResponse">
    </iron-ajax>

    <iron-ajax
      id="ajaxGetImages"
      url="http://rebelcricket.lacuna.club/api/images"
      headers='{{headers}}'
      handle-as="json"
      last-response="{{images}}">
    </iron-ajax>

    <iron-ajax
      id="ajaxCreateImage"
      url="http://rebelcricket.lacuna.club/api/create_image"
      method="POST"
      headers='{{headers}}'
      on-response="_handleAjaxCreateImagePostResponse"
      on-error="_handleAjaxCreateImagePostError"
      >
    </iron-ajax>
<!--     <iron-ajax
      auto
      url="http://rebelcricket.lacuna.club/api/"
      params='{"page":"about"}'
      handle-as="json"
      on-response="_handlePageResponse">
    </iron-ajax> -->


    <app-drawer-layout fullbleed>

      <app-drawer>
          <app-toolbar><span id="headerToolbar">Admin</span></app-toolbar>
          <div id="drawerButtonsContainer" hidden>
            <div class="drawer-button"><paper-button class="custom" on-tap="_setCurrentPage" page="Api Key">Api Key</paper-button></div>
            <div class="drawer-button"><paper-button class="custom" on-tap="_setCurrentPage" page="Pages">Pages</paper-button></div>
            <div class="drawer-button"><paper-button class="custom" on-tap="_setCurrentPage" page="Images">Images</paper-button></div>
          </div>
      </app-drawer>

      <app-header-layout>

        <app-header condenses reveals effects="waterfall">
          <app-toolbar>
              <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
          </app-toolbar>
          <app-toolbar>
            <div main-title><h4>[[currentPage]]</h4></div>
            <template is="dom-if" if="[[isPages]]">
              <paper-button class="custom" on-tap="_savePages">Save Pages</paper-button>
            </template>
          </app-toolbar>
        </app-header>

      </app-header-layout>

      <div id="apiKeyContainer" hidden>
        <div class="row">
          <div class="col s6 offset-s3">
            <paper-input label="Api Key" value="{{admin.apiKey}}"></paper-input>
          </div>

        </div>
      </div>

      <div id="pagesContainer" hidden>

        <template is="dom-repeat" items="{{pages}}" as="page">
          <div>
            <h5>
              [[page.name]]
              <template is="dom-if" if="[[_isServices(page.name)]]">
                ([[page.data.items.length]])
              </template>
            </h5>
            <hr>
            <template is="dom-if" if="[[page.data.heading]]">
              <paper-input label="Heading" value="{{page.data.heading}}"></paper-input>
              
            </template>

            <template is="dom-if" if="[[page.data.items]]">
              <div class="row">
                <b>items:</b>
                <template is="dom-repeat" items="{{page.data.items}}">
                  <template is="dom-if" if="[[!_isServices(page.name)]]"> 
                    <paper-input label="Title" value="{{item.title}}"></paper-input>
                    <paper-textarea label="Description" value="{{item.description}}"></paper-textarea>
                  </template>

                  <template is="dom-if" if="[[item.image]]">
                    Main Image:
                    <ul>
                    <li><paper-input label="URL" value="{{item.image}}"></paper-input></li>
                    <li><paper-input label="Name" value="{{item.name}}"></paper-input></li>
                    <li><paper-input label="Slug" value="{{item.slug}}"></paper-input></li>
                    </ul>
                  </template>

                  <template is="dom-if" if="[[_isServices(page.name)]]"> 
                    Detail Images:
                    <ul>
                    <template is="dom-repeat" items="{{_getDetailImages(page.data, item.slug)}}" as="detailImage">
                      <li>
                        <paper-input label="URL" value="{{detailImage}}"></paper-input>
                      </li>
                    </template>
                      <li><paper-button class="custom" on-tap="_addDetailImage">Add Detail Image</paper-button></li>
                    </ul>
                  </template>

                  <div>[[_getDescription(page.data, item.slug)]]</div>

                  <template is="dom-repeat" items="{{_getDescriptionItems(page.data, item.slug)}}" as="descriptionItem">
                    <paper-input label="Heading" value="{{descriptionItem.name}}"></paper-input>

                    <paper-textarea label="Description Item" value="{{descriptionItem.description}}"></paper-textarea>
                    <br><br>
                  </template>

                 
                  <paper-fab mini on-tap="_removeDescriptionItem" class="custom" label="&nbsp;&times;"></paper-fab>
                

                </template>

                <div class="row description-item">
                  <div class="col s12">
                    <paper-button class="custom" on-tap="_addDescriptionItem">Add Description Item</paper-button>
                  </div>
                </div>
              </div>

              <template is="dom-if" if="[[_isServices(page.name)]]">
                <div class="row">
                  <div class="col s12 center">
                    <paper-button class="custom" on-tap="_addService">Add Service</paper-button>
                  </div>
                </div>
              </template>
            </template>

            <template is="dom-if" if="[[page.data.attachments]]">
              <div class="row">
                <div class="col s12">
                  <b>attachments:</b><br>
                  <template is="dom-repeat" items="{{page.data.attachments}}">
                  <ul>
                  <li><paper-input label="Caption" value="{{item.caption}}"></paper-input></li>
                  <li><paper-input label="Name" value="{{item.name}}"></paper-input></li>
                  <li><paper-input label="URL" value="{{item.url}}"></paper-input></li>
                  <li>
                  <paper-fab mini on-tap="_removeAttachment" class="custom" label="&nbsp;&times;"></paper-fab>
                  </li>
                  </ul>
                  </template>
                </div>
              </div>
              <div class="row">
                <div class="col s12 center">
                  <paper-button class="custom" on-tap="_addAttachment">Add Attachment</paper-button>
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>

      <div id="imagesContainer" hidden>
        <div class="row">
          <div class="col s12 m6 offset-m3">
            <br><br><br>
            <label for="rebelImages">&nbsp;Upload Image file</label>
            <input id="rebelImages" type="file"></input>

            <paper-spinner id="rebelImagesSpinner" alt="Uploading File..."></paper-spinner>
            <span id="rebelImagesFeedback"></span>
          </div>
        </div>
        <div class="row">
          <div class="col s12">
            <template is="dom-repeat" items="{{images}}">
              <img class="rebel-image" src$="[[item.url]]">
            </template>
          </div>
        </div>

      </div>

    </app-drawer-layout>
   
  </template>

  <script>

    Polymer({

      is: 'rebelcricket-admin',
      properties: {
        admin: {
          type: Object,
          notify: true,
          observer: '_adminObserver'
        },
        apiKey: {
          type: String,
          notify: true,
          value: function(){
            return '';
          }
        },
        headers: {
          type: Object,
          computed: '_header(apiKey)'
        },
        hasValidApiKey: {
          type: Boolean,
          notify: true,
          computed: '_validateApiKey(apiKey)'
        },
        pages: {
          type: Array,
          notify: true,
          observer: '_pagesObserver'
        },
        isPages: {
          type: Boolean,
          notify: true
        },
        currentPage: {
          type: String,
          notify: true,
          observer: '_currentPageChanged',
          value: function(){
            return 'Api Key';
          }
        },
        images: {
          type: Array,
          notify: true
        }
      },
      _header: function(_apiKey) {
        console.log('_header _apiKey:',_apiKey);
        return {'Authorization': 'Token token="'+_apiKey+'"'};
      },
      _adminObserver: function(admin){
        if(admin.apiKey != undefined && admin.apiKey != ''){
          console.log('api key from pouch:',admin.apiKey);
          if(this.apiKey != admin.apiKey){
            this._validateApiKey(admin.apiKey);
          }
        }
      },
      _pagesObserver: function(_pages){
        console.log('_pagesObserver _pages:',_pages);
      },
      _currentPageChanged: function(_currentPage){
        if(_currentPage === 'Api Key'){
          this.$.apiKeyContainer.hidden = false;
          this.$.pagesContainer.hidden = true;
          this.$.imagesContainer.hidden = true;
          this.set('isPages', false);
        }else if(_currentPage === 'Pages'){
          this.$.ajaxGetPages.generateRequest();
          this.$.apiKeyContainer.hidden = true;
          this.$.pagesContainer.hidden = false;
          this.$.imagesContainer.hidden = true;
          this.set('isPages', true);
        }else if(_currentPage === 'Images'){
          this.$.ajaxGetImages.generateRequest();
          this.$.apiKeyContainer.hidden = true;
          this.$.pagesContainer.hidden = true;
          this.$.imagesContainer.hidden = false;
          this.set('isPages', false);
        }
      },
      _setCurrentPage: function(e){
        console.log('_setCurrentPage e.target.getAttribute(page):',e.target.getAttribute('page'));
        this.set('currentPage', e.target.getAttribute('page'));
      },
      _validateApiKey: function(apiKey){
        console.log('_validateApiKey: ',apiKey == undefined || apiKey == '');
        this.set('apiKey', apiKey);
        //return apiKey == undefined || apiKey == '';
        this.$.ajaxValidateApiKey.generateRequest();
      },
      _toggleDrawer: function(e){
        this.$.drawer.toggle();
      },
      _handleValidateApiKeyResponse: function(e){
        console.log('_handleValidateApiKeyResponse e.detail.xhr.statusText:',e.detail.xhr.statusText);
        if(e.detail.xhr.statusText === 'OK'){
          this.$.drawerButtonsContainer.hidden = false;
          this.set('currentPage', 'Pages');
        }
      },
      _handleUpdatePageResponse: function(e){
         console.log('_handleUpdatePageResponse e.detail.xhr.statusText:',e.detail.xhr.statusText);
      },
      _getDescription: function(_page_data, _slug){
        return _page_data[_slug].description;
      },
      _getDescriptionItems: function(_page_data, _slug){
        if(_page_data[_slug].detail_items != undefined){
          return _page_data[_slug].detail_items;
        }
      },
      _getDetailImages: function(_page_data, _slug){
        if(_page_data[_slug].detail_images != undefined){
          return _page_data[_slug].detail_images;
        }
      },
      _handleAjaxCreateImagePostResponse: function(e){
        console.log('_handleAjaxCreateImagePostResponse e:',e);
        this.$.rebelImagesSpinner.active = false;
        this.$.ajaxGetImages.generateRequest();
      },
      _handleAjaxCreateImagePostError: function(e){
        console.log('_handleAjaxCreateImagePostError e:',e);
        this.$.rebelImagesSpinner.active = false;
      },
      _savePages: function(e){
        console.log('_savePages e:',e);
        console.log('this.pages:',this.pages);
      },
      _addAttachment: function(e){
        e.model.page.data.attachments.push({caption: '', name: '', url: ''});
        var _idx = this.pages.indexOf(e.model.page);
        var _data = e.model.page.data;
        this.set('pages.'+_idx+'.data', {});
        this.set('pages.'+_idx+'.data', _data);
      },
      _removeAttachment: function(e){
        //dunno why e.model.page is not accessiable here, but assuming constant position at index 0 for the 'about' page...
        this.splice('pages.0.data.attachments', e.model.index, 1);
      },
      _addService: function(e){
        console.log('_addService e:',e);
      },
      _addDescriptionItem: function(e){
        console.log('_addDescriptionItem e.model.page:',e.model.page);
        // e.model.page.data.attachments.push({caption: '', name: '', url: ''});
        var _idx = this.pages.indexOf(e.model.page);
        // var _data = e.model.page.data;
        // this.set('pages.'+_idx+'.data', {});
        // this.set('pages.'+_idx+'.data', _data);
        this.push('pages.'+_idx+'.data.items', {description: '', title: ''});
      },
      _removeDescriptionItem: function(e){
        console.log('_addDescriptionItem e.model.page:',e.model.page);
        // e.model.page.data.attachments.push({caption: '', name: '', url: ''});
        var _idx = this.pages.indexOf(e.model.page);
        this.splice('pages.'+_idx+'.data.items', e.model.index, 1);
      },
      _addDetailImage: function(e){
        console.log('_addDetailImage e:',e);
      },
      _isServices: function(_pageName){
        return _pageName == 'services';
      },
      ready: function(){
        //file upload
        var input = this.$.rebelImages;
        var _this = this;
        input.addEventListener('change', function () {
          var file = input.files[0]; // file is a Blob

          _this.$.rebelImagesSpinner.active = true;

          var params = {};
          params["filename"] = file.name;
          _this.$.ajaxCreateImage.params = params;

          var formData = new FormData();
          formData.append('file', file);

          _this.$.ajaxCreateImage.body = formData;
          _this.$.ajaxCreateImage.generateRequest();

        });


      }


    });

  </script>

</dom-module>
