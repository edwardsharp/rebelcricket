<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">

<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="rebelcricket-icons.html">
<link rel="import" href="rebelcricket-vendor.html">

<script src="util.js"></script>
<script src="models.js"></script>
<script src="underscore-min.js"></script>
<script src="rgbquant.js"></script>

<dom-module id="rebelcricket-quote">
  <template>
    <style is="custom-style" include="shared-styles">    

      :host {
        font-size: 16px;
        --primary-color: red;
        --default-primary-color: red;
      }

      paper-button.custom, paper-fab.custom {
        background: rgba(255,0,0,0.8);
        margin: 1em;
        display: inline-block;
      }

      paper-button.custom:hover, paper-fab.custom:hover {
        background: red;
        color: black;
      }

      paper-icon-button:hover {
        color: red;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-input, paper-textarea {
        width: 100%;
        --paper-input-container-color: black;
        --paper-input-container-input-color: black;
      }

      paper-menu {
        --paper-menu-selected-item: {
          color: red;
        }
      }

      paper-menu-button {
        padding: 0;
      }

      paper-listbox.custom {
        max-height: 160px;
        overflow: hidden;
        overflow-y: scroll;
        border: thin solid #ccc;
        border-radius: 5px;
        margin-bottom: 1em;
      }

      paper-item.custom:nth-child(even):not(.iron-selected) { 
        background: #f6f6f6; 
      }

      paper-item.smallfont { 
        font-size: 13px; 
      }

      paper-item.iron-selected { 
        background-color: red;
        color: white!important;
      }


      hr {
        width: 97%;
      }

      .section-label {
        justify-content: center;
        font-size: 20px;
        font-weight: 100;
        text-transform: uppercase;
        width: 100%;
        background-color: #333;
        border-radius: 5px;
        margin-bottom: 1em;
      }
      .section-label span{
        color: white;
        height: 1.5em;
        text-align: center;
        padding-left: 0.5em;
        padding-right: 0.5em;
      }
      .rebel-font{
        font-family: 'ObelixPro';
        font-weight: 100;
        font-size: 2em;
        line-height: 1em;
      }

      .center{
        text-align: center;
        justify-content: center;
        width: 100%;
      }

      .group{
        border: thin solid #666;
        border-radius: 5px;

      }

      .serviceItems paper-icon-button {
        margin-top: 10px;
      }

      .apparelRow, .serviceGroup {
        border-bottom: thin dotted #ccc;
      }

      .graphicItems{
        border: thin solid #666;
        border-radius: 5px;
        padding: 10px;
      }

      .needsDateToggle {
        margin-top: 25px;
      }

      #quoteDesignFileWrapper {
        padding-left: 1.4em;
      }
      
      #quoteDesignFileWrapper label, #quoteDesignFileWrapper input {
        font-size: 22px;
        line-height: 15px;
      }

      #quoteDesignFileWrapper label:hover {
        color: red;
      }

      @media (max-width: 600px) {
        .section-label span{
       
          height: auto;
          padding: 0 2px 0 2px;
        }

        paper-item.custom { 
          font-size: 13px; 
        }

      }

      @media (max-width: 875px) {
        .section-label span{
          height: auto;
        }
      }


    </style>

    <app-pouchdb-conflict-resolution
      strategy="lastWriteWins">
    </app-pouchdb-conflict-resolution>

    <app-pouchdb-document
      db-name="quotes"
      doc-id="{{quoteID}}"
      data="{{quote}}">
    </app-pouchdb-document>
  
    <app-pouchdb-document
      db-name="vendorItem"
      doc-id="{{quoteID}}"
      data="{{vendorItem}}">
    </app-pouchdb-document>

    <iron-ajax
      id="rebelquote"
      url="http://rebelcricket.lacuna.club/api/rebelquote"
      method="POST"
      content-type="application/json"
      handle-as="json"
      on-response="_handleAjaxQuotePostResponse"
      on-error="_handleAjaxQuotePostError"
      >
    </iron-ajax>

    <iron-ajax
      id="rebelgfx"
      url="http://rebelcricket.lacuna.club/api/rebelgfx"
      method="POST"
      on-response="_handleAjaxGfxPostResponse"
      on-error="_handleAjaxGfxPostError"
      >
    </iron-ajax>
    

    <iron-ajax
      id="rebelgfxdelete"
      url="http://rebelcricket.lacuna.club/api/delete_image"
      method="DELETE"
      >
    </iron-ajax>

    <paper-dialog id="scrolling">
      <paper-dialog-scrollable>
        <rebelcricket-vendor line-item="{{lineItemForVendor}}" quote-id="{{quoteID}}"></rebelcricket-vendor>
      </paper-dialog-scrollable>
      <!-- <div class="buttons">
        <paper-button class="custom">I don't know</paper-button>
        <paper-button class="custom">Something else</paper-button>
      </div> -->
    </paper-dialog>

    <paper-dialog id="submitFeedback">
      <h2>Quote Submission</h2>
      <paper-dialog-scrollable>
        <p id="submitFeedbackText">Thank you for submitting a quote request! <br><br> We'll get back to you shortly with an estimate and/or additional questions for the service(s) you requested.</p>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button class="custom" dialog-confirm autofocus>Okay</paper-button>
      </div>
    </paper-dialog>

    <div>

      <div class="row">
        <div class="col s12 center">
          <h1 class="rebel-heading">
            <template is="dom-if" if="[[quote.services.length]]">
              Quote
            </template>
            <template is="dom-if" if="[[!quote.services.length]]">
              Contact
            </template>
          </h1>
        </div>
      </div>


      <div class="">
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>[[quote.client_contact_information.label]]</span>
              </div>
              <template is="dom-repeat" items="{{quote.client_contact_information.items}}">
                <div class$="col [[item.col]]">
                  <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                </div>
              </template>
            </div>
          </div>
          
          <div class="row">

            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Services</span>
              </div>
              
              
              <template is="dom-repeat" items="{{quote.services}}" as="quoteServiceItem">
                <div class="row group">
                  <div class="row serviceGroup">
                    <div class="col s6 center">
                      <paper-dropdown-menu class="service-dropdown" label="Service" on-iron-select="_serviceSelected" disabled$="[[_serviceDropdownNeedsDisabled(quoteServiceItem.value)]]">
                        <paper-listbox class="dropdown-content" selected="{{quoteServiceItem.value}}">
                          <template is="dom-repeat" items="{{services}}">
                            <paper-item value="[[item.value]]" disabled$=[[_serviceNeedsDisabled(item.name)]]>[[item.name]]</paper-item>
                          </template>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                    <div class="col s4 center">
                      <template is="dom-if" if="[[_isApparelService(quoteServiceItem)]]">
                        <small>Cost of goods:</small>
                        <h5>[[quoteServiceItem.total]] $[[quoteServiceItem.total_price]]</h5>
                      </template>
                    </div>
                    <div class="col s2">
                      <paper-icon-button icon="remove" on-tap="_removeService"></paper-icon-button>
                      <small>remove</small>
                      <paper-tooltip>Remove Service</paper-tooltip>

                    </div>
                  </div>

                  <div class="serviceItems col s12 center">
                    
                    <!-- Apparel -->
                    <template is="dom-if" if="[[_isApparelService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.line_items.items}}" as="lineItem">
                        <div class="col s12 apparelRow">
       
                          <div class="col s2">
        
                            <paper-icon-button icon="shopping-basket" on-tap="_openDialog"></paper-icon-button>
                            <small>browse</small>

                          </div>

                          <template is="dom-repeat" items="{{lineItem.brand_style_color}}">
                            <div class$="col [[item.col]]">
                              <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input>
                            </div>
                          </template>

                          <div class="col s2">
                            <paper-menu-button ignore-select>
                              <paper-icon-button icon="add" class="dropdown-trigger"></paper-icon-button>
                              <paper-menu class="dropdown-content" selected-values="{{lineItem.selected_sizes}}" multi>
                                <template is="dom-repeat" items="[[lineItem.apparel_sizes]]">
                                  <paper-item>[[item]] [[_priceForSize(lineItem, item)]]</paper-item>
                                </template>
                              </paper-menu>
                            </paper-menu-button>
                            <small>select sizes</small>
                          </div>
                          
                          <div class="col s2">
                            <paper-icon-button icon="remove" on-tap="_removeLineItemRow"></paper-icon-button>
                            <small>remove</small>
                            <paper-tooltip>Remove Textile</paper-tooltip>
                          </div>

                          <div class="col s12">
                            <template is="dom-repeat" items="{{lineItem.size_quantity}}">
                              <div class$="col [[item.col]]">
                                <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}"></paper-input><small>[[item.total]]</small>
                              </div>
                            </template>

                            <template is="dom-if" if="[[lineItem.line_total]]">
                              <div class$="col [[lineItem.line_total.col]]">
                                <paper-input name="[[lineItem.line_total.key]]" label="[[lineItem.line_total.label]]" value="{{lineItem.line_total.value}}" readonly="true"></paper-input>
                                <small>$[[lineItem.line_total.total]]</small>
                              </div>
                            </template>

                          </div>
                        </div>

                        <div class="row">
                          <div class="col s12 center">

                            <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                            <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                          </div>
                        </div>

                      </template>
                      
                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addApparelLineItemRow">Add another textile</paper-button>
                      </div>

                    </template>

                    <!-- Posters -->

                    <template is="dom-if" if="[[_isPosterService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.poster_line_items.items}}" as="lineItem">

                      <div class="row">

                        <div class="col s3">
                          <paper-input label="Quantity" value="{{lineItem.quantity}}"></paper-input>
                          <small>Poster Minimum: <b>[[lineItem.poster_min]]</b></small>
                        </div>
       
                      </div>
                      <div class="row">

                        <div class="col s4">
                          <paper-dropdown-menu label="Stock Color">
                            <paper-listbox class="dropdown-content" selected="{{lineItem.selected_poster_stock}}">
                              <paper-item class="custom"></paper-item>
                              <template is="dom-repeat" items="{{lineItem.poster_stock_colors}}">
                                <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                              </template>
                            </paper-listbox>
                          </paper-dropdown-menu>
                        </div>
                        <div class="col s4">
                          <paper-dropdown-menu label="Stock Size">
                            <paper-listbox class="dropdown-content" selected="{{lineItem.selected_poster_size}}">
                              <paper-item class="custom"></paper-item>
                              <template is="dom-repeat" items="{{lineItem.poster_sizes}}">
                                <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                              </template>
                            </paper-listbox>
                          </paper-dropdown-menu>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col s12 center">
                          <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                          <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                        </div>
                      </div>
                      </template>

                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addPosterLineItemRow">Add more [[quoteServiceItem.name]]</paper-button>
                      </div>
                    </template> 

                    <!-- Stickers -->

                    <template is="dom-if" if="[[_isStickerService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.sticker_line_items.items}}" as="lineItem">

                      <div class="row">

                        <div class="col s3">
                          <paper-input label="Quantity" value="{{lineItem.quantity}}"></paper-input>
                          <small>Sticker Minimum: <b>[[lineItem.sticker_min]]</b></small>
                        </div>

                      </div>
                      <div class="row">

                        <div class="col s4">
                          <paper-dropdown-menu label="Stock Color">
                            <paper-listbox class="dropdown-content" selected="{{lineItem.selected_sticker_stock}}">
                              <paper-item class="custom"></paper-item>
                              <template is="dom-repeat" items="{{lineItem.sticker_stock_colors}}">
                                <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                              </template>
                            </paper-listbox>
                          </paper-dropdown-menu>
                        </div>

                        
                        <div class="col s4">
                          <paper-dropdown-menu label="Size">
                            <paper-listbox class="dropdown-content" selected="{{lineItem.selected_sticker_size}}">
                              <paper-item class="custom"></paper-item>
                              <template is="dom-repeat" items="{{lineItem.sticker_sizes}}">
                                <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                              </template>
                            </paper-listbox>
                          </paper-dropdown-menu>
                        </div>

                      </div>

                      <div class="row">
                        <div class="col s12 center">
                          <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                          <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                        </div>
                      </div>
                      </template>

                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addStickerLineItemRow">Add more [[quoteServiceItem.name]]</paper-button>
                      </div>
                    </template>


                    <!-- Sandblasting -->

                    <template is="dom-if" if="[[_isSandblastingService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.sandblasting_line_items.items}}" as="lineItem">

                      <div class="row">

                        <div class="col s4">
                          <paper-input label="Quantity" value="{{lineItem.quantity}}"></paper-input>
                        </div>
           
                        <div class="col s4">
                          <small>Substrate</small>
                          <paper-listbox class="custom" selected-values="{{lineItem.selected_substrates}}" multi>
                            <template is="dom-repeat" items="{{lineItem.substrates}}">
                              <paper-item class$="[[_itemNeedsSmallFont(item)]] custom" value="[[item]]">[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class="col s4">
                          <small>Color Fill</small>
                          <paper-listbox class="custom" selected-values="{{lineItem.selected_fill_colors}}" multi>
                            <paper-item class="custom" value="none" selected>none</paper-item>
                            <template is="dom-repeat" items="{{lineItem.fill_colors}}">
                              <paper-item class$="[[_itemNeedsSmallFont(item)]] custom" value="[[item]]">[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </div>

                      </div>

                      <div class="row">
                        <div class="col s12 center">
                          <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                          <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                        </div>
                      </div>

                      </template>

                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addSandblastingLineItemRow">Add more [[quoteServiceItem.name]]</paper-button>
                      </div>

                    </template>

                    <!-- Sublimation -->

                    <template is="dom-if" if="[[_isSublimationService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.sublimation_line_items.items}}" as="lineItem">

                      <div class="row">

                        <div class="col s4">
                          <paper-input label="Quantity" value="{{lineItem.quantity}}"></paper-input>
                          <small>Mug/Bottle Minimum: [[lineItem.bottle_min]] </small>
                        </div>
                        <br><br>
                    
                      </div>
                      <div class="row">

                        <div class="col s4">
                          <small>Available Goods</small>
                          <paper-listbox class="custom" selected-values="{{lineItem.selected_sublimation_items}}" multi>
                            <template is="dom-repeat" items="{{lineItem.sublimation_items}}">
                              <paper-item class$="[[_itemNeedsSmallFont(item)]] custom" value="[[item]]">[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class="col s4">
                          <small>Bottle Options</small>
                          <paper-listbox class="custom" selected-values="{{lineItem.selected_watter_bottle_options}}" multi>
                            <template is="dom-repeat" items="{{lineItem.watter_bottle_options}}">
                              <paper-item class$="[[_itemNeedsSmallFont(item)]] custom" value="[[item]]">[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </div>

                        <div class="col s4">
                          <small>Bottle Top</small>
                          <paper-listbox class="custom" selected-values="{{lineItem.selected_watter_bottle_tops}}" multi>
                            <template is="dom-repeat" items="{{lineItem.watter_bottle_tops}}">
                              <paper-item class$="[[_itemNeedsSmallFont(item)]] custom" value="[[item]]">[[item]]</paper-item>
                            </template>
                          </paper-listbox>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col s12 center">
                          <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                          <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                        </div>
                      </div>

                      </template>
                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addSublimationLineItemRow">Add more [[quoteServiceItem.name]]</paper-button>
                      </div>
                    </template>

                    <!-- Die-Cut Vinyl -->
 
                    <template is="dom-if" if="[[_isVinylService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.vinyl_line_items.items}}" as="lineItem">

                      <div class="row">

                        <div class="col s3">
                          <paper-input label="Quantity" value="{{lineItem.quantity}}"></paper-input>
                        </div>

                        <div class="col s4">
                          <paper-input label="Dimensions" value="{{lineItem.dimensions}}"></paper-input>
                          <small>Height x Width</small>
                        </div>
                        
                        <div class="col s5">
                          <paper-dropdown-menu label="Options">
                            <paper-listbox class="dropdown-content" selected="{{lineItem.selected_option}}">
                              <paper-item class="custom"></paper-item>
                              <template is="dom-repeat" items="{{lineItem.options}}">
                                <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                              </template>
                            </paper-listbox>
                          </paper-dropdown-menu>
                        </div>

                      </div>

                      <div class="row">
                        <div class="col s12 center">
                          <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                          <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                        </div>
                      </div>

                      </template>
                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addVinylLineItemRow">Add more [[quoteServiceItem.name]]</paper-button>
                      </div>
                    </template>

                    <!-- Dimensional Parts -->

                    <template is="dom-if" if="[[_isDimensionalPartsService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.dimensional_parts_line_items.items}}" as="lineItem">

                      <div class="row">

                        <div class="col s6">
                          <paper-input label="Dimensions" value="{{lineItem.dimensions}}"></paper-input>
                          <small>Specify Height x Width x Depth size(s).</small>
                        </div>
                        
                        <div class="col s6">
                          <small>Options</small>
                          <paper-listbox class="custom" selected-values="{{lineItem.selected_options}}" multi>
                            <template is="dom-repeat" items="{{lineItem.options}}">
                              <paper-item class$="[[_itemNeedsSmallFont(item)]] custom" value="[[item]]">[[item]]</paper-item>
                            </template>
                          </paper-listbox>

                        </div>

                      </div>

                      <div class="row">
                        <div class="col s12 center">

                          <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                          <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                        </div>
                      </div>

                      </template>
                    </template>

                    <!-- Buttons -->

                    <template is="dom-if" if="[[_isButtonsService(quoteServiceItem)]]">
                      <template is="dom-repeat" items="{{quote.buttons_line_items.items}}" as="lineItem">

                      <div class="row">

                        <div class="col s3">
                          <paper-input label="Quantity" value="{{lineItem.quantity}}"></paper-input>
                          <small>Button order minimum: [[lineItem.buttons_min]]</small>
                        </div>
                        
                        <div class="col s3">

                          <paper-dropdown-menu label="Size">
                            <paper-listbox class="dropdown-content" selected="{{lineItem.selected_size}}">
                              <paper-item class="custom"></paper-item>
                              <template is="dom-repeat" items="{{lineItem.sizes}}">
                                <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                              </template>
                            </paper-listbox>
                          </paper-dropdown-menu>

                        </div>

                      </div>

                      <div class="row">
                        <div class="col s12 center">

                          <paper-textarea label="Notes" value="{{lineItem.serviceNotes}}"></paper-textarea>
                          <small>Any additional information about this [[quoteServiceItem.name]] item?</small>
                        </div>
                      </div>

                      </template>

                      <div class="col s12 center">
                        <paper-button class="custom" on-tap="_addButtonsLineItemRow">Add more [[quoteServiceItem.name]]</paper-button>
                      </div>
                    </template>


                  </div>
                  
                </div>
              </template>
             

              <div class="col s12 center">
                <paper-button class="custom" on-tap="_addAnotherService">[[addServiceButtonText]]</paper-button>
              </div>

            </div>

          </div>
          
          <template is="dom-if" if="[[quote.services.length]]">
          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Graphics</span>
              </div> 
              
            </div>
            
            <div class="col s12 m6 offset-m3">
             
              <template is="dom-repeat" items="{{quote.graphic.items}}">
                <div class="row graphicItems">
                  <div class="col s4">
                    <!-- <a on-tap="_getPaletteInfo"></a> -->
                      <img src="[[item.attachment_url]]" class="responsive-img quoteDesignImg">
                    
                  </div>

                  <div class="col s6">
                    <paper-input label="Print Size" value="{{item.size_inches}}"></paper-input>
                    <small>Height x Width (inches)</small>
                  </div>

                  <div class="col s2">
                    <paper-icon-button icon="remove" on-tap="_removeGraphic"></paper-icon-button>
                    <small>remove</small>
                    <paper-tooltip>Remove Graphic</paper-tooltip>

                  </div> 

                  <div class="col s12">
                    Print This On <small>select as many as needed.</small>
                    <paper-listbox class="custom" selected-values="{{item.print_on_items}}" on-iron-activate="_printOnItemsChanged" multi>
                      <template is="dom-repeat" items="{{printOnItems}}">
                        <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                      </template>
                    </paper-listbox>
                  </div>
                  
                  <div class="col s6 m4">
                    Position <br><small>select as many as needed.<br>Only applicable to apparel.</small>
                    <paper-listbox class="custom" selected-values="{{item.print_positions}}" multi>
                      <template is="dom-repeat" items="{{positions}}">
                        <paper-item class="custom" value="[[item]]">[[item]]</paper-item>
                      </template>
                    </paper-listbox>
                  </div>
                  
                  <div class="col s4">

                    <paper-dropdown-menu label="Number of Colors" on-iron-select="_numColorsChanged">
                      <paper-listbox class="dropdown-content" selected="{{item.num_colors}}">
                        <template is="dom-repeat" items="{{numColors}}">
                          <paper-item value="[[item]]">&nbsp;&nbsp;[[item]]&nbsp;&nbsp;</paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>
                    <small>Max: Apparel 8, Stickers 4</small>

                  </div>
           
                  <template is="dom-repeat" items="{{item.colors}}" as="color">
                    <div class="col s4 m3">
                      <paper-input name="color" label="Ink Color" value="{{color}}" style$="background-color:rgba([[color]]);"></paper-input>
                    </div>
                  </template>
               
                  <div class="row">
                    <div class="col s12">
                      <paper-checkbox checked={{item.needs_white_base}}>
                          &nbsp; Needs white base
                      </paper-checkbox>
                      <small>Note: to get vibrant colors printed on dark textiles, it's recommended to first apply a layer of white ink. </small>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col s12">
                      <paper-textarea rows="2" label="Graphic Notes" value="{{item.notes}}"></paper-textarea>
                      <small>Please add any additional information about this graphic.</small>
                    </div>
                  </div>

                </div>
              </template>
          
              <br>
            </div>

            <div class="col s12 m6 offset-m3" id="quoteDesignFileWrapper">

              <label for="quoteDesignFile"><iron-icon icon="add"></iron-icon>Upload Image Files</label>
              <input id="quoteDesignFile" type="file"></input>

              <paper-spinner id="quoteDesingUploadSpinner" alt="Uploading File..."></paper-spinner>
              <span id="quoteDesignUploadFeedback"></span>
              <div>
                <small>Graphic files can be sent as ai, eps, pdf, psd, svg, jpeg, or tiff. They should be sized to the desired print size at 300 dpi. If you have a physical copy of the art let us know, weâ€™ll schedule a time for you to bring it in and discuss the options. </small>
              </div>
            </div>



          </div>

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">

                  <span>[[quote.job_completion_and_shipping.label]]</span>
                </div>
                <br>
                <br>
                <template is="dom-repeat" items="{{quote.job_completion_and_shipping.items}}">
                  <div class$="col [[item.col]]">
                    <template is="dom-if" if="[[_isInput(item.type)]]">
                      <paper-input name="[[item.key]]" label="[[item.label]]" value="{{item.value}}" hidden$="[[!quote.job_completion_and_shipping.items.2.value]]"></paper-input>
                      <small hidden$="[[!quote.job_completion_and_shipping.items.2.value]]" >[[item.notes]]</small>
                    </template>
                    <template is="dom-if" if="[[_isTextarea(item.type)]]">
                      <paper-textarea rows="[[item.rows]]" name="[[item.key]]" label="[[item.label]]" value="{{item.value}}" hidden$="[[!quote.job_completion_and_shipping.items.2.value]]"></paper-textarea>
                      <small hidden$="[[!quote.job_completion_and_shipping.items.2.value]]">[[item.notes]]</small>
                    </template>
                    <template is="dom-if" if="[[_isCheckbox(item.type)]]">
                      <paper-checkbox checked="{{item.value}}"> [[item.label]]</paper-checkbox>
                      <br><small>[[item.notes]]</small>
                    </template>
                  </div>
                </template>
                <div class="row">
                  <div class="col s12">
                    <p hidden$="[[!quote.job_completion_and_shipping.items.1.value]]">
                    Our Address is 5040 SE Milwaukie Ave. Portland, OR 97202</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </template>

          <div class="row">
            <div class="col s12 m6 offset-m3">
              <div class="col s12 section-label center">
                <span>Other</span>
              </div>
              <template is="dom-if" if="[[quote.services.length]]">
              <div class="col s8">
                <paper-dialog id="dateNeededPicker" class="paper-date-picker-dialog" modal>
                  <paper-date-picker id="picker" date="{{dateNeeded}}" min-date="[[now]]"></paper-date-picker>
                  <div class="buttons">
                    <paper-button class="custom" dialog-confirm>Done</paper-button>
                  </div>
                </paper-dialog>
                
                <paper-toggle-button class="red needsDateToggle" on-tap="_toggleNeedDate" checked="{{quote.need_by_date}}">Do you need this by a certain date?</paper-toggle-button>
                <br><small>Rush Processing Available! Rates Vary. <br>Please add a note if you need something fast.</small>
              
              </div>

              <div class="col s4">
                <template is="dom-if" if="[[quote.need_by_date]]">
                <span id="needsDateContainer">
                  [[quote.date_needed]]
                  <paper-fab mini on-tap="_openDatePicker" icon="calendar" class="custom"></paper-fab>
                  <paper-tooltip>Pick Date</paper-tooltip>
                </span>
                </template>
              </div>
              </template>

              <div class="col s12">
                <paper-textarea rows="4" label="Notes" value="{{quote.notes}}"></paper-textarea>
                <small>Please add any additional information or questions.</small>
              </div>

            </div>
          </div>
          

          <div class="row">
            <div class="col s12 m6 offset-m3 center">
              <paper-button id="submitQuoteButton" class="custom" on-tap="_submitQuote">
                <h5>Submit 
                <template is="dom-if" if="[[quote.services.length]]">
                  Quote
                </template>
                </h5>
              </paper-button>
            </div>
          </div>

      </div>


    </div>

  </template>

  <script>

  Polymer({
    is: 'rebelcricket-quote',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      services: {
        type: Array,
        notify: false,
        value: function(){
          return [ 
            { name: "Apparel", value: "apparel"}, 
            { name: "Dimensional Parts", value: "dimensional-parts"}, 
            { name: "Posters", value: "posters"}, 
            { name: "Stickers", value: "stickers"},
            { name: "Buttons", value: "buttons"}, 
            { name: "Die-Cut Vinyl", value: "die-cut-vinyl"}, 
            { name: "Sandblasting", value: "sandblasting"},
            { name: "Sublimation", value: "sublimation"}
          ];
        }
      },
      quote: {
        type: Object,
        notify: true,
        observer: '_quoteObserver',
        value: function() {
          return quoteModel;
        }
      },
      quoteID: {
        type: String,
        notify: false,
        value: function() { 
          if(window.location.hash === ''){
            window.location.hash = generateID();
            //#TODO: ajax fetch json from api? (probz admin thing...)
          }
          return window.location.hash.replace(/#/,'');
        }
      },
      sizeItems: {
        type: Array,
        notify: true,
        observer: '_sizeItemsChanged'
      },
      printOnItems: {
        type: Array,
        notify: true
      },
      dateNeeded: {
        type: Date,
        notify: true,
        observer: '_quoteNeedByDateObserver'
      },
      lineItemForVendor: {
        type: Object,
        notify: true,
        observer: '_lineItemForVendorObserver'
      },
      lineItemIdxForVendor:{
        type: Number,
        notify: true
      },
      vendorItem: {
        type: Object,
        notify: true,
        observer: '_vendorItemObserver'
      },
      numColors: {
        type: Array,
        notify: false,
        value: function(){
          return Array.apply(null, {length: 20}).map(Number.call, Number);
        }
      },
      positions: {
        type: Array,
        notify: false,
        value: function(){
          return [
            "Front Center",
            "Front Left",
            "Front Right",
            "Back Center",
            "Back Lower",
            "Left Sleeve",
            "Right Sleeve",
            "Not Sure",
            "Other (please describe)"
          ]
        }
      },
      now: {
        type: Date,
        notify: true,
        value: function(){
          var fourdayslater = new Date;
          fourdayslater.setDate(fourdayslater.getDate() + 4);
          return fourdayslater;
        }
      }, 
      addServiceButtonText: {
        type: String,
        notify: true,
        computed: '_addServiceButtonText(quote.services)'
      }
    },
    _quoteNeedByDateObserver: function(e){
      this.set('quote.date_needed', this._formatDate(this.dateNeeded));
    },
    _formatDate: function(date){
      return date.getFullYear() + "-" + ("0"+(date.getMonth() + 1)).slice(-2) + "-" + ("0"+date.getDate()).slice(-2);
    },
    _serviceSelected: function(e){
      // console.log('_serviceSelected e.target.selected:',e.target.selected);
      e.model.set('quoteServiceItem', {name: this.services[e.target.selected].name, value: e.target.selected});
      if(e.target.selected == 0 && this.quote.line_items.items.length == 0){ //
        // console.log('!!! _serviceSelected, gonna _addApparelLineItemRow()');
        this._addApparelLineItemRow();
      }else if(e.target.selected == 1 && this.quote.dimensional_parts_line_items.items.length == 0){
        this._addDimensionalPartsItemRow();
      }else if(e.target.selected == 2 && this.quote.poster_line_items.items.length == 0){
        this._addPosterLineItemRow();
      }else if(e.target.selected == 3 && this.quote.sticker_line_items.items.length == 0){
        this._addStickerLineItemRow();
      }else if(e.target.selected == 4 && this.quote.buttons_line_items.items.length == 0){
        this._addButtonsLineItemRow();
      }else if(e.target.selected == 5 && this.quote.vinyl_line_items.items.length == 0){
        this._addVinylLineItemRow();
      }else if(e.target.selected == 6 && this.quote.sandblasting_line_items.items.length == 0){
        this._addSandblastingLineItemRow();
      }else if(e.target.selected == 7 && this.quote.sublimation_line_items.items.length == 0){
        this._addSublimationLineItemRow();
      }

    },
    _serviceNeedsDisabled: function(quoteService){
      return _.where(this.quote.services, {name: quoteService}).length > 0;
    },
    _serviceDropdownNeedsDisabled: function(_val){
      return _val != undefined;
    },
    _isApparelService: function(quoteService){
      return quoteService.name.match(/apparel/i); 
    },
    _isPosterService: function(quoteService){
      return quoteService.name.match(/poster/i); 
    },
    _isStickerService: function(quoteService){
      return quoteService.name.match(/sticker/i); 
    },
    _isSandblastingService: function(quoteService){
      return quoteService.name.match(/sandblasting/i); 
    },
    _isSublimationService: function(quoteService){
      return quoteService.name.match(/sublimation/i); 
    },
    _isVinylService: function(quoteService){
      return quoteService.name.match(/vinyl/i); 
    },
    _isDimensionalPartsService: function(quoteService){
      return quoteService.name.match(/dimensional/i); 
    },
    _isButtonsService: function(quoteService){
      return quoteService.name.match(/buttons/i); 
    },
    _isOtherService: function(quoteService){
      return quoteService.name != undefined && quoteService.name != '' && !quoteService.name.match(/apparel/i);
    },
    _sizeItemsChanged: function(){
      // console.log('_sizeItemsChanged this.sizeItems:',this.sizeItems);
    },
    _openDatePicker: function(e){
      // console.log('_openDatePicker');
      this.$.dateNeededPicker.open();
    },
    _addAnotherService: function(e){
      // console.log('ADD ANOTHER SERVICE!');
      this.push('quote.services', {name: '', value: undefined });
    },
    _removeService: function(e){
      
      var _serviceName = this.quote.services[e.model.index].name;

      //need to do this splice before resetting _line_items...
      this.splice('quote.services', e.model.index, 1);

      if(_serviceName == 'Apparel'){
        this.set('quote.line_items.items', []);
      }else if(_serviceName == 'Dimensional Parts'){
        this.set('quote.dimensional_parts_line_items.items', []);
      }else if(_serviceName == 'Posters'){
        this.set('quote.poster_line_items.items', []);
      }else if(_serviceName == 'Stickers'){
        this.set('quote.sticker_line_items.items', []);
      }else if(_serviceName == 'Buttons'){
        this.set('quote.buttons_line_items.items', []);
      }else if(_serviceName == 'Sandblasting'){
        this.set('quote.sandblasting_line_items.items', []);
      }else if(_serviceName == 'Sublimation'){
        this.set('quote.sublimation_line_items.items', []);
      }else if(_serviceName == 'Die-Cut Vinyl'){
        this.set('quote.vinyl_line_items.items', []);
      }

    },
    _removeGraphic: function(e){
      // console.log('_removeGraphic e.model.index:',e.model.index);
      // console.log('right gfx?',this.quote.graphic.items[e.model.index]);
      var params = {};
      params["id"] = this.quote.graphic.items[e.model.index].attachment_id;
      params["rebel_quote_number"] = this.quoteID;
      this.$.rebelgfxdelete.params = params;
      this.$.rebelgfxdelete.generateRequest();
      
      this.splice('quote.graphic.items', e.model.index, 1);

    },
    _addServiceButtonText: function(_quote_services){
      if(_quote_services && _quote_services.length > 0){
        return 'Add another service';
      }else{
        return 'Add a service';
      }
    },
    _quoteObserver: function(_quote){
      try{
        // console.log('QUOTE _quoteObserver, _quote:',_quote);

        var lineItemsTotalPrice = 0
          , lineItemsTotal = 0
        _.each(_quote.line_items.items, function(item){
          if(item.service_type == 'Apparel'){
            if(item.selected_sizes.length != item.size_quantity.length){
              // console.log('different sizes selected, need to adjust .apparel_sizes!');
              var _sizes = _.map(item.selected_sizes, function(size){return item.apparel_sizes[size]; });
              // console.log('have sizes:', _sizes );
              // console.log('wut about item.size_quantity? ',item.size_quantity);
              _size_quantity = [];
              _.each(_sizes, function(size,idx){
                if(_.where(item.size_quantity, {key: size}).length > 0){
                  _size_quantity.push(_.where(item.size_quantity, {key: size})[0]);
                }else{
                  var _size_proto = quoteModel.apparel_size_quantity_proto;
                  _size_proto.key = size;
                  _size_proto.label = size;
                  if(item.prices != undefined && item.prices[idx] != undefined){
                    _size_proto.total = item.prices[item.apparel_sizes.indexOf(size)];
                  }
                  _size_quantity.push(_size_proto);
                }
              });
              if(_size_quantity.length > 0){
                item.line_total = quoteModel.line_item_apparel_total_proto.line_total;
              }else{
                item.line_total = undefined;
              }
              item.size_quantity = _size_quantity;
            } // if item.selected_sizes.length != item.size_quantity.length

            if(item.line_total != undefined){
              item.line_total.value = _.reduce(_.where(item.size_quantity, {sum: true}), function(memo, v){ return memo + (v.value != undefined && v.value != '' ? parseInt(v.value) : 0); }, 0);
              lineItemsTotal += item.line_total.value;
              try{
                item.line_total.total = _.reduce(_.where(item.size_quantity, {sum: true}), function(memo, v){ return memo + (v.total != undefined && !isNaN(parseFloat(v.total.replace(/\$/,''))) ? (v.value == undefined ? 0 : v.value) * parseFloat(v.total.replace(/\$/,'')) : 0); }, 0).toFixed(2);

                lineItemsTotalPrice += parseFloat(item.line_total.total);
                //console.log('parseFloat(v.total.replace(/\$/)', v.total.replace(/\$/,'')); console.log('v.value:',v.value);
                // console.log('zomg, item.line_total.total:',item.line_total.total);

              }catch(err){
                //o noz!
              }
              
            }
            
          }// if item.service_type == 'Apparel'
        });

        // if(lineItemsTotalPrice > 0 || lineItemsTotal > 0){}
        var _li = _.where(this.quote.services, {name: "Apparel"})[0];
        if(_li){
          _li.total = lineItemsTotal;
          _li.total_price = lineItemsTotalPrice.toFixed(2);
        }
        
        this._updatePrintOnItems();
      }catch(err){
        //o noz!
        console.log('o noz! _quoteObserver caught err:',err);
      }
    },
    _isInput: function(type){
      return type == 'text' || type == 'number';
    },
    _isTextarea: function(type){
      return type == 'textarea';
    },
    _isCheckbox: function(type){
      return type == 'checkbox';
    },
    _addApparelLineItemRow: function(){
      var _li_proto = quoteModel.line_item_apparel_proto;
      this.push('quote.line_items.items',_li_proto); 
    },
    _addPosterLineItemRow: function(){
      var _li_proto = quoteModel.line_item_poster_proto;
      this.push('quote.poster_line_items.items',_li_proto); 
    },
    _addStickerLineItemRow: function(){
      var _li_proto = quoteModel.line_item_sticker_proto;
      this.push('quote.sticker_line_items.items',_li_proto); 
    },
    _addSandblastingLineItemRow: function(){
      var _li_proto = quoteModel.line_item_sandblasting_proto;
      this.push('quote.sandblasting_line_items.items',_li_proto); 
    },
    _addSublimationLineItemRow: function(){
      var _li_proto = quoteModel.line_item_sublimation_proto;
      this.push('quote.sublimation_line_items.items',_li_proto); 
    },
    _addVinylLineItemRow: function(){
      var _li_proto = quoteModel.line_item_vinyl_proto;
      this.push('quote.vinyl_line_items.items', _li_proto);
    },
    _addButtonsLineItemRow: function(){
      var _li_proto = quoteModel.line_item_buttons_proto;
      this.push('quote.buttons_line_items.items', _li_proto);
    },
    _removeLineItemRow: function(e){
      this.splice('quote.line_items.items', e.model.index, 1);
    },
    _addDimensionalPartsItemRow: function(){
      var _li_proto = quoteModel.line_item_dimensional_parts_proto;
      this.push('quote.dimensional_parts_line_items.items', _li_proto);
    },
    _addColorMeshPrint: function(e){
      //ugh, RTFM: https://www.polymer-project.org/1.0/docs/devguide/data-system#paths
      //An index, for example, "myArray.1" indicates the array item at position 1.
      //An opaque key, prefixed with the pound sign (#), for example, "myArray.#1" indicates the array item with the key "1".
      this.push('quote.graphic.items.'+e.model.index+'.color_mesh_print', quoteModel.graphic.items[0].color_mesh_print[0]);
    },
    _addNewGraphic: function(e){
      this.push('quote.graphic.items', quoteModel.graphic.items[0]);
    },
    _openDialog: function(e){
      // console.log('need to set li, do we have it? e.model.lineItem',e.model.lineItem);
      this.set('lineItemForVendor', e.model.lineItem);
      this.set('lineItemIdxForVendor', e.model.index);
      this.set('vendorItem.exit', false);
      this.set('vendorItem.colorsSelected', {});
      this.$.scrolling.open();
    },
    _toggleNeedDate: function(e){ 
      if(e.target.checked){
        this._openDatePicker();
      }
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    _vendorItemObserver: function(_vendorItem){
      // console.log('QUOTE _vendorItemObserver _vendorItem:',_vendorItem);
      if(_vendorItem.exit){
        // console.log('QUOTE vendorItem exit!!! _vendorItem.exit:',_vendorItem.exit);
        this.$.scrolling.close();

        if(Object.keys(_vendorItem.colorsSelected).length > 0 && this.quote.line_items != undefined && this.quote.line_items.items[this.lineItemIdxForVendor] != undefined){
          
          var _lineItems = this.quote.line_items.items;
          var _lineItem = this.quote.line_items.items[this.lineItemIdxForVendor]; 
          _lineItems.splice(this.lineItemIdxForVendor, 1);

          var _this = this;
          _.each(_vendorItem.colorsSelected, function(v,k,o){
            var _li = JSON.parse(JSON.stringify(_lineItem)); //eek.
            _li.brand_style_color[0].value = _vendorItem.product.brand;
            _li.brand_style_color[1].value = _vendorItem.product.style;
            _li.brand_style_color[2].value = k;
            _li.apparel_sizes = v.sizes;
            _li.prices = v.prices;
            _li.price_href = v.price_href;
            // console.log('!!!!quote k:',k,', gonna push _li',_li);
            // console.log('!!!!_vendorItem.colorsSelected o:',o);
            // console.log('do we have it???? v.price_href:',v.price_href);
            _lineItems.push(_li);
      
          });

          this.set('quote.line_items.items', _lineItems);
          
        }
        
      }
    },
    _lineItemForVendorObserver: function(_lineItem){
      // console.log('QUOTE _lineItemForVendorObserver _lineItem:',_lineItem);
    },
    _priceForSize: function(_li, _item){

      var _itemIdx = _li.apparel_sizes.indexOf(_item);
      
      if(!isNaN(parseInt(_itemIdx)) && _li.prices){
        return _li.prices[_itemIdx]; 
      }else{
        return '';
      }
    },
    _numColorsChanged: function(e){
      if(e.model.item.colors.length != e.target.selected){
        e.model.item.colors.length = e.target.selected;
        e.model.item.colors = Array.apply(null, e.model.item.colors).map(String.prototype.valueOf,"");
        this.notifyPath('quote.graphic.items.'+e.model.index+'.colors');
      }
    },
    _updatePrintOnItems: function(){
      var _itemz = [];
      try{
        _itemz.push( _.map(this.quote.line_items.items, function(item){return _.map(item.brand_style_color, function(i){return i.value;}).join(', ');}) );
        if(this.quote.poster_line_items.items.length > 0){
          _itemz.push( _.map(this.quote.poster_line_items.items, function(item, k){return 'Poster ' +(k+1);}) );
        }
        if(this.quote.sticker_line_items.items.length > 0){
          _itemz.push( _.map(this.quote.poster_line_items.items, function(item, k){return 'Sticker ' +(k+1);}) );
        }
        if(this.quote.buttons_line_items.items.length > 0){
          _itemz.push( _.map(this.quote.buttons_line_items.items, function(item, k){return 'Button ' +(k+1);}) );
        }
        if(this.quote.vinyl_line_items.items.length > 0){
          _itemz.push( _.map(this.quote.vinyl_line_items.items, function(item, k){return 'Die-Cut Vinyl ' +(k+1);}) );
        }
        if(this.quote.sandblasting_line_items.items.length > 0){
          _itemz.push( _.map(this.quote.sandblasting_line_items.items, function(item, k){return 'Sandblasting ' +(k+1);}) );
        }
        if(this.quote.sublimation_line_items.items.length > 0){
          _itemz.push( _.map(this.quote.sublimation_line_items.items, function(item, k){return 'Sublimation ' +(k+1);}) );
        }
      }catch(err){
        //o noz!
      }
      _itemz.push( _.map(this.quote.services, function(serv){return 'All '+serv.name;}) );
      if( ! _.isEqual(this.printOnItems, _itemz) ){
        this.set('printOnItems', _.flatten(_itemz));
      }
    },
    _printOnItemsChanged: function(e){
      var _idx = e.model.index;
      var _item = e.model.item;
      this.async(function(){
        var __printOnItems = this.printOnItems;
        var _print_on_item_names = [];
        _.each(_item.print_on_items, function(poi){
          if(__printOnItems[poi]){
            _print_on_item_names.push(__printOnItems[poi]);
          }
        });
        this.set('quote.graphic.items.'+_idx+'.print_on_item_names', _print_on_item_names);
      }, 500);
      
    },
    _getPaletteInfo: function(e){

      // options with defaults (not required)
      var opts = {
          colors: 256,             // desired palette size
          method: 2,               // histogram method, 2: min-population threshold within subregions; 1: global top-population
          boxSize: [64,64],        // subregion dims (if method = 2)
          boxPxls: 2,              // min-population threshold (if method = 2)
          initColors: 4096,        // # of top-occurring colors  to start with (if method = 1)
          minHueCols: 0,           // # of colors per hue group to evaluate regardless of counts, to retain low-count hues
          dithKern: null,          // dithering kernel name, see available kernels in docs below
          dithDelta: 0,            // dithering threshhold (0-1) e.g: 0.05 will not dither colors with <= 5% difference
          dithSerp: false,         // enable serpentine pattern dithering
          palette: [],             // a predefined palette to start with in r,g,b tuple format: [[r,g,b],[r,g,b]...]
          reIndex: false,          // affects predefined palettes only. if true, allows compacting of sparsed palette once target palette size is reached. also enables palette sorting.
          useCache: true,          // enables caching for perf usually, but can reduce perf in some cases, like pre-def palettes
          cacheFreq: 10,           // min color occurance count needed to qualify for caching
          colorDist: "euclidean",  // method used to determine color distance, can also be "manhattan"
      };

      try{
        
        var q = new RgbQuant(opts);

        // analyze histograms
        // console.log('_getPaletteInfo selector?',this.$$('.quoteDesignImg'));
        q.sample(this.$$('.quoteDesignImg'));

        // build palette
        var pal = q.palette();
        // console.log('!! _getPaletteInfo pal:',pal);

        var _colors = [];
        var _numColors = pal.length > 60 ? 60 : pal.length;

        for (var i = 0; i < _numColors; i=i+4) {
          _colors.push( pal[i] +', '+ pal[i+1] +', '+ pal[i+2] +', '+ pal[i+3] );
        }
        this.set('quote.graphic.items.0.colors', _colors);
        this.async(function(){ this.set('quote.graphic.items.0.num_colors', (_numColors / 4).toFixed(0) ); }, 200);
        
        // reduce images
        // var outA = q.reduce(_file);

        // console.log('_getPaletteInfo _numColors:',_numColors,' _colors:',_colors);

      }catch(err){
        console.log('o noz! could not _getPaletteInfo!');
      }
      
    },
    _submitQuote: function(){

      this.$.submitQuoteButton.disabled = true;

      var params = {};
      params["number"] = this.quoteID;
      params["name"] = this.quote.client_contact_information.items[0].value;
      params["phone"] = this.quote.client_contact_information.items[1].value;
      params["email"] = this.quote.client_contact_information.items[2].value;
      params["org"] = this.quote.client_contact_information.items[3].value;

      // console.log('paramz:',params);
      //&& this.quote.services.length > 0
      if(  
        params["name"] !== '' 
        && params["name"] != undefined 
        && params["email"] !== '' 
        && params["email"] != undefined 
        && params["phone"] !== '' 
        && params["phone"] != undefined 
      ){
        this.set('quote.submitted', new Date);
        this.$.rebelquote.params = params;
        this.$.rebelquote.body = JSON.stringify({data: this.quote });
        
        this.$.rebelquote.generateRequest();
      }else{
        // if(this.quote.services.length == 0){
        //  this.$.submitFeedbackText.innerHTML = "ERROR! Please select at least one service. (Note: click 'ADD A SERVICE' button, then select the service you need.)<br><br>";
        // }else{
        this.$.submitFeedbackText.innerHTML = "ERROR! Please fill our your name, email, and phone!<br><br>";
        // }
        //window.location.href ?
        this.$.submitFeedback.open();
        this.$.submitQuoteButton.disabled = false;
      }
      
    },
    _handleAjaxQuotePostResponse: function(e){
      // console.log('_handleAjaxQuotePostResponse! e',e);
      this.$.submitFeedbackText.innerHTML = "Thank you for submitting a quote request! <br><br> We'll get back to you shortly with either <ol><li>Answers to any questions you might have.</li><li>An estimate.</li><li>Additional questions (or information needed) about the service(s) you requested.</li><ol><br><br><div>If anything comes up in the meantime, please don't hesitate to email <a href='mailto:rebelcricket@gmail.com'>rebelcricket@gmail.com</a> or call <a href='tel://1-503-545-1450'>503â€‘545â€‘1450</a>. </div>";
      //window.location.href ?
      this.$.submitFeedback.open();
      this.$.submitQuoteButton.disabled = false;
    },
    _handleAjaxQuotePostError: function(e){
      // console.log('_handleAjaxQuotePostError! e:',e);
      this.$.submitFeedbackText.innerHTML = 'ERROR! Could not submit your quote request. Sorry about that. :/ <br><br> If this form does not work for you please email your request to <a href="mailto: rebelcricket@gmail.com">rebelcricket@gmail.com</a>. <br><br>Or call us <a href="tel://1-503-545-1450">503â€‘545â€‘1450</a>';
      this.$.submitFeedback.open();
      this.$.submitQuoteButton.disabled = false;
    },
    _handleAjaxGfxPostResponse: function(e){
      var graphic_item = quoteModel.graphic_item_proto;
      graphic_item.attachment_id = e.detail.response.id;
      graphic_item.attachment_url = e.detail.response.url;
      this.push('quote.graphic.items', graphic_item);
      this.$.quoteDesingUploadSpinner.active = false;
      this.$.quoteDesignUploadFeedback.innerHTML = '';
      this.$.quoteDesignFile.disabled = false;
    },
    _handleAjaxGfxPostError: function(e){
      // console.log('_handleAjaxGfxPostError! e:',e);
      this.$.quoteDesingUploadSpinner.active = false;
      this.$.quoteDesignUploadFeedback.innerHTML = 'ERROR! Could not upload that file. Please try again or choose a different file. If this form does not work for you please email your graphics to <a href="mailto: rebelcricket@gmail.com">rebelcricket@gmail.com</a>.';
      this.$.quoteDesignFile.disabled = false;
    },
    _itemNeedsSmallFont: function(str){
      return str.length > 16 ? 'smallfont' : '';
    },
    ready: function(){
      //file upload
      var input = this.$.quoteDesignFile;
      var _this = this;
      input.addEventListener('change', function () {
        _this.$.quoteDesignFile.disabled = true;
        var file = input.files[0]; // file is a Blob

        _this.$.quoteDesingUploadSpinner.active = true;

        var params = {};
        params["quote_number"] = _this.quoteID;
        params["filename"] = _this.quoteID+'-'+file.name;
        _this.$.rebelgfx.params = params;

        var formData = new FormData();
        formData.append('file', file);

        _this.$.rebelgfx.body = formData;
        _this.$.rebelgfx.generateRequest();

      });

    }

  });

  </script>
</dom-module>
