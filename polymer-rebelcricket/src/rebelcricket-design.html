<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="rebelcricket-pouchdb.html"> -->
<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<!-- <link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html">
 -->
<script src="../bower_components/pouchdb/dist/pouchdb.js"></script>
<script src="../bower_components/pouchdb-find/dist/pouchdb.find.js"></script>
<script src="../bower_components/fabric.js/dist/fabric.js"></script>
<script src="../bower_components/blob-util/dist/blob-util.js"></script>

<dom-module id="rebelcricket-design">
  <template>
    <style is="custom-style">    

      paper-button.custom {
        background: white;
        color: #333;
      }

      paper-button.custom:hover {
        background: #333;
        color: white;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      .container{
        text-align: center;
      }

      .flex-wrap {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      .flex-wrap div {
        min-width: 200px;
      }
      @media (max-width: 767px) {


      }

    </style>

    <app-pouchdb-document
      db-name="http://localhost:5984/cats"
      doc-id="parsnip"
      data="{{cat}}">
    </app-pouchdb-document>

      <app-pouchdb-document
        db-name="http://localhost:5984/cats"
        doc-id="mydoc"
        data="{{mydoc}}">
      </app-pouchdb-document>

    <app-pouchdb-index
      db-name="http://localhost:5984/cats"
      fields='["name"]'>
    </app-pouchdb-index>
    <app-pouchdb-query
      db-name="http://localhost:5984/cats"
      selector="name $exists true"
      fields='["_id","name"]'
      sort='["name"]'
      data="{{cats}}">
    </app-pouchdb-query>

    <app-pouchdb-query
      db-name="http://localhost:5984/cats"
      selector="_attachments $exists true"
      fields='["_id","_attachments"]'
      data="{{designImages}}">
    </app-pouchdb-query>

    <div class="container">
    <header>
      <h1>Design</h1>
    </header>
    <div class="flex-wrap">
      <div>
        <input
          id="catInput"
          is="iron-input"
          bind-value="{{cat.name}}">
        </input>
      </div>
      <div>
        <canvas id="c" width="300" height="300" style="border:1px solid #ccc"></canvas>
      </div>
      <div>


        <template is="dom-repeat" items="{{designImages}}">
          <template is="dom-repeat" items="{{_attachmentKeys(item._attachments)}}" as="attachment">
            <img src="http://localhost:5984/cats/{{item._id}}/{{ attachment }}" height="100" width="100">
          </template>
        </template>
        <br>
        <input id="catFile" type="file"></input>
        <br>
        <select>
        <template id="rebelCats" is="dom-repeat" items="{{cats}}">
          <option value="{{item.name">{{item.name}}</option>
        </template>
        </select>

      </div>
    </div>
    </div>

  </template>

  <script>

  Polymer({
    is: 'rebelcricket-design',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    // properties: {
    //   mydoc: Object
    // },

    // _toArray: function(obj) {
    //   return Object.keys(this.mydoc).map(function(key) {
    //     return {
    //         name: key,
    //         value: this.mydoc[key]
    //     };
    //   });
    // },
    _log: function(wut){
      console.log('wut:',wut);
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    // _getImgSrc: function(attachment){
    //   var db = new PouchDB('http://localhost:5984/cats');
    //   db.getAttachment('mydoc', attachment).then(function (blobOrBuffer) {
    //     return URL.createObjectURL(blobOrBuffer);
    //   }).catch(function (err) {
    //     console.log(err);
    //   });
    //   // Object.keys(attachment);
    //   // console.log('_getImgSrc:',attachment);
    //   // console.log('_getImgSrc:',URL.createObjectURL(attachment));
    //   // return URL.createObjectURL(attachment);
    // },
    ready: function(){

      // console.log('mydoc:',this.mydoc);

      var canvas = new fabric.Canvas(this.$.c);

      var rect = new fabric.Rect({
          top : 100,
          left : 100,
          width : 60,
          height : 70,
          fill : 'red'
      });

      canvas.add(rect);

      //file upload
      var db = new PouchDB('http://localhost:5984/cats');

      var catImage = this.$.catImage;

      // console.log('designImages:',this.designImages);

      // var images = [];
      // db.get('mydoc').then(function (doc) {
      //   // var img = document.createElement('img');
      //   // Polymer.dom(this.$.designImages).appendChild(img);
      //   for(var key in doc._attachments) {
      //     // skip loop if the property is from prototype
      //     if (!doc._attachments.hasOwnProperty(key)) continue;
      //     // var obj = doc._attachments[key];
      //     db.getAttachment('mydoc', key).then(function (blobOrBuffer) {
      //       console.log('URL.createObjectURL(blobOrBuffer):',URL.createObjectURL(blobOrBuffer));
      //       console.log('blobOrBuffer:',blobOrBuffer);
      //       // console.log('blobUtil.createObjectURL(blobOrBuffer):',blobUtil.createObjectURL(blobOrBuffer));
      //       images.push({ src: URL.createObjectURL(blobOrBuffer) });
      //     }).catch(function (err) {
      //       console.log(err);
      //     });

      //   }

      //   //this.pushImages(images);
      //   //this.designImages.push(images);
        

      // });

      

      

      var input = this.$.catFile;
      input.addEventListener('change', function () {
        var file = input.files[0]; // file is a Blob

        // console.log('input file:',file);

        // var attachments = {};
        // attachments[file.name] = {
        //   content_type: file.type,
        //   type: file.type,
        //   data: file
        // }

        // db.put({
        //   _id: 'mydoc',
        //   _attachments: attachments
        // }).catch(function (err) {
        //   console.log(err);
        // });

        // var attachment = new Blob(file, {type: file.type});
        db.putAttachment(file.name, file.name, file, file.type).then(function (result) {
          // handle result
        }).catch(function (err) {
          console.log(err);
        });



      });

    }


  });


  </script>
</dom-module>
