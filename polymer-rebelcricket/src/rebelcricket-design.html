<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="rebelcricket-pouchdb.html"> -->
<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<!-- <link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html"> -->
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<script src="../bower_components/pouchdb/dist/pouchdb.js"></script>
<script src="../bower_components/pouchdb-find/dist/pouchdb.find.js"></script>
<script src="../bower_components/fabric.js/dist/fabric.js"></script>
<script src="../bower_components/blob-util/dist/blob-util.js"></script>

<dom-module id="rebelcricket-design">
  <template>
    <style is="custom-style">    

      paper-button.custom {
        background: white;
        color: #333;
      }

      paper-button.custom:hover {
        background: #333;
        color: white;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-toggle-button.green {
        --paper-toggle-button-checked-bar-color:  var(--paper-green-500);
        --paper-toggle-button-checked-button-color:  var(--paper-green-500);
        --paper-toggle-button-checked-ink-color: var(--paper-green-500);
        --paper-toggle-button-unchecked-bar-color:  var(--paper-teal-500);
        --paper-toggle-button-unchecked-button-color:  var(--paper-teal-500);
        --paper-toggle-button-unchecked-ink-color: var(--paper-teal-500);
      }

      .center{
        text-align: center;
      }

      .flex-wrap {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      .flex-wrap div {
        min-width: 200px;
      }

      #design-controls{
        padding-left: 2em;
        padding-right: 2em;
      }
      #design-element-container{
        width: 530px;
        height: 630px;
        position: relative;
      }

      #design-element-img-container{
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      #design-element-canvas-container {

        position: absolute;
        top:115px;
        left: 165px;
        z-index: 2;
      }

      canvas:hover{
        border:thin solid #ccc;
      }


      #catInput{
        display: none;
      }
      @media (max-width: 767px) {


      }

    </style>

    <app-pouchdb-document
      db-name="http://localhost:5984/cats"
      doc-id="parsnip"
      data="{{cat}}">
    </app-pouchdb-document>

 <!--      <app-pouchdb-document
        db-name="http://localhost:5984/cats"
        doc-id="mydoc"
        data="{{mydoc}}">
      </app-pouchdb-document> -->

    <app-pouchdb-index
      db-name="http://localhost:5984/cats"
      fields='["name"]'>
    </app-pouchdb-index>
    <app-pouchdb-query
      db-name="http://localhost:5984/cats"
      selector="name $exists true"
      fields='["_id","name"]'
      sort='["name"]'
      data="{{cats}}">
    </app-pouchdb-query>

    <app-pouchdb-query
      db-name="http://localhost:5984/cats"
      selector="_attachments $exists true"
      fields='["_id","_attachments"]'
      data="{{designImages}}">
    </app-pouchdb-query>

    <div class="container">
    <header class="center">
      <h1>Design</h1>
    </header>
    <div class="flex-wrap">
      <div id="design-controls">
        <input
          id="catInput"
          is="iron-input"
          bind-value="{{cat.name}}">
        </input>
        <br>
        <paper-dropdown-menu label="Style" on-iron-select="_styleSelected">
          <paper-listbox class="dropdown-content" selected="0">
            <paper-item value="crew">Crew</paper-item>
            <paper-item value="womens_crew">Women's Crew</paper-item>
            <paper-item value="hoodie">Hoodie</paper-item>
            <paper-item value="longsleeve">Long Sleeve</paper-item>
            <!-- <paper-item value="tank">Tank</paper-item> -->
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-swatch-picker color="{{designElementColor}}" column-count=4 color-list='["#000000", "#65a5f2", "#83be54", "#f0d551", "#e5943c", "#a96ddb", "#B20000", "#ffffff"]'></paper-swatch-picker>
        <br><br>
        <paper-toggle-button class="green" id="toggle-design-element-img" on-tap="_toggleDesignElementImg">Show Back</paper-toggle-button>
        <br>
        <label for="catFile">Add Image</label>
        <input id="catFile" type="file"></input>
        <br><br>

        <template is="dom-repeat" items="{{designImages}}">
          <template is="dom-repeat" items="{{_attachmentKeys(item._attachments)}}" as="attachment">
            <img src="http://localhost:5984/cats/{{item._id}}/{{ attachment }}" height="50" width="50">
          </template>
        </template>
        <br>

        <div id="objectTools" hidden$="{{objectToolsHidden}}">
          <h1> object toolz!</h1>
        </div>
      </div>
      <div id="design-element-container">
        <div id="design-element-img-container">
          <img id="design-element-img">
        </div>
        <div id="design-element-canvas-container">
          <canvas id="c" width="200" height="400"></canvas>
        </div>
      </div>
      <div>


      
        
       <!--  <br>
        <select>
        <template id="rebelCats" is="dom-repeat" items="{{cats}}">
          <option value="{{item.name">{{item.name}}</option>
        </template>
        </select> -->

      </div>
    </div>
    </div>

  </template>

  <script>

  Polymer({
    is: 'rebelcricket-design',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      designElementColor: String,
      canvas: {
        type: Object,
        notify: true
      },
      designImages: {
        type: Object,
        notify: true
        // value: function() { return {}; }
      },
      objectToolsHidden: {
        type: Boolean,
        notify: true,
        value: true
      }

    },
    listeners: {
      'color-picker-selected': '_designElementColorChange',
      'design-images-changed': '_designImagesChanged'
    },
    // _toArray: function(obj) {
    //   return Object.keys(this.mydoc).map(function(key) {
    //     return {
    //         name: key,
    //         value: this.mydoc[key]
    //     };
    //   });
    // },
    _designElementColorChange: function(e){
      console.log('designElementColorChange',e.detail.color);
      console.log("this.$$('#design-element-img'):",this.$$('#design-element-img'));
      // var t = Polymer.dom(e).localTarget; // design-element-img-container
      this.$$('#design-element-img').setAttribute('style', 'background-color:'+e.detail.color);
      // t.customStyle['--background-color'] = e.detail.color;
      // customStyle['--color'] 
      // .customStyle['--an-ele-name-bgcolor'] = 'pink'; //background-color
      // t.updateStyles();
      // Polymer.updateStyles();
    },
    _styleSelected: function(e){
      this.$$('#design-element-img').src = '/images/design/'+e.target.selectedItem.getAttribute('value')+'_front.png';
      this.$$('#toggle-design-element-img').checked = false;
    },
    _toggleDesignElementImg: function(e){
      console.log('_toggleDesignElementImg e.target.checked:',e.target.checked);
      if(e.target.checked){
        this.$$('#design-element-img').src = this.$$('#design-element-img').src.replace(/front/, 'back');
        e.target.innerHTML = 'Show Front';
      }else{
        this.$$('#design-element-img').src = this.$$('#design-element-img').src.replace(/back/, 'front');
        e.target.innerHTML = 'Show Back';
      }
    },
    _designImagesChanged: function(e){
      this.designImages = e.detail.value;
      console.log('_designImagesChanged e.detail:',e.detail.value,' this.designImages',this.designImages);
      for(var key in this.designImages){
        var attachments = Object.keys(this.designImages[key]._attachments);
        for(var aKey in attachments){
          console.log('src:','http://localhost:5984/cats/'+this.designImages[key]._id+'/'+attachments[aKey] )
          e.target._addImageToCanvas('http://localhost:5984/cats/'+this.designImages[key]._id+'/'+attachments[aKey]);
        }
      }
    },
    _addImageToCanvas: function(url){
      var _thisCanvas = this.canvas; //ugh, scope
      fabric.Image.fromURL(url, function(oImg) {
        oImg.scaleToWidth(200);
        _thisCanvas.add(oImg);
      });
    },
    _log: function(wut){
      console.log('wut:',wut);
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    _onObjectSelected: function(e){
      this.set('objectToolsHidden', false);
    },
    _onSelectionCleared: function(e){
      this.set('objectToolsHidden', true);
    },
    ready: function(){

      this.canvas = new fabric.Canvas(this.$.c);
      // console.log('mydoc:',this.mydoc);

      console.log('this.canvas checck', this.canvas);

      var rect = new fabric.Rect({
          top : 100,
          left : 100,
          width : 60,
          height : 70,
          fill : 'red'
      });

      this.canvas.add(rect);

      // this.canvas.on('object:moving', function(options) { 
      //   //snap to the edge of the canvas (but can go over the edge...)
      //   if(options.target.top > -5 && options.target.top < 5){
      //     options.target.set({
      //       top: 0,
      //     });
      //   }
      //   if(options.target.right > 195 && options.target.right < 205){
      //     options.target.set({
      //       right: 200,
      //     });
      //   }
      //   if(options.target.bottom > 395 && options.target.bottom < 405){
      //     options.target.set({
      //       bottom: 400,
      //     });
      //   }
      //   if(options.target.left > -5 && options.target.left < 5){
      //     options.target.set({
      //       left: 0,
      //     });
      //   }
      // });


      this.canvas.on({
       'object:moving': function(e) {       
          e.target.opacity = 0.5;
          //snap to edge of canvas #TODO: look up canvas height/width
          if(e.target.top > -5 && e.target.top < 5){
            e.target.set({
              top: 0,
            });
          }
          if(e.target.right > 195 && e.target.right < 205){
            e.target.set({
              right: 200,
            });
          }
          if(e.target.bottom > 395 && e.target.bottom < 405){
            e.target.set({
              bottom: 400,
            });
          }
          if(e.target.left > -5 && e.target.left < 5){
            e.target.set({
              left: 0,
            });
          }

        },
        'object:modified': function(e) {        
          e.target.opacity = 1;
        },
        //very important, need to bind to this scope...
       'object:selected': this._onObjectSelected.bind(this),
       'selection:cleared': this._onSelectionCleared.bind(this)
      });
      // designImages
      // _attachmentKeys(item._attachments


      //file upload
      var db = new PouchDB('http://localhost:5984/cats');

      var catImage = this.$.catImage;

      // console.log('designImages:',this.designImages);

      // var images = [];
      // db.get('mydoc').then(function (doc) {
      //   // var img = document.createElement('img');
      //   // Polymer.dom(this.$.designImages).appendChild(img);
      //   for(var key in doc._attachments) {
      //     // skip loop if the property is from prototype
      //     if (!doc._attachments.hasOwnProperty(key)) continue;
      //     // var obj = doc._attachments[key];
      //     db.getAttachment('mydoc', key).then(function (blobOrBuffer) {
      //       console.log('URL.createObjectURL(blobOrBuffer):',URL.createObjectURL(blobOrBuffer));
      //       console.log('blobOrBuffer:',blobOrBuffer);
      //       // console.log('blobUtil.createObjectURL(blobOrBuffer):',blobUtil.createObjectURL(blobOrBuffer));
      //       images.push({ src: URL.createObjectURL(blobOrBuffer) });
      //     }).catch(function (err) {
      //       console.log(err);
      //     });

      //   }

      //   //this.pushImages(images);
      //   //this.designImages.push(images);
        

      // });

      

      

      var input = this.$.catFile;
      input.addEventListener('change', function () {
        var file = input.files[0]; // file is a Blob

        // console.log('input file:',file);

        // var attachments = {};
        // attachments[file.name] = {
        //   content_type: file.type,
        //   type: file.type,
        //   data: file
        // }

        // db.put({
        //   _id: 'mydoc',
        //   _attachments: attachments
        // }).catch(function (err) {
        //   console.log(err);
        // });

        // var attachment = new Blob(file, {type: file.type});
        db.putAttachment(file.name, file.name, file, file.type).then(function (result) {
          // handle result
        }).catch(function (err) {
          console.log(err);
        });



      });

    }


  });


  </script>
</dom-module>
