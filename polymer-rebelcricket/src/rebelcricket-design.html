<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="rebelcricket-pouchdb.html"> -->
<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<!-- <link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html"> -->
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<script src="../bower_components/pouchdb/dist/pouchdb.js"></script>
<script src="../bower_components/pouchdb-find/dist/pouchdb.find.js"></script>
<script src="../bower_components/fabric.js/dist/fabric.js"></script>
<script src="../bower_components/blob-util/dist/blob-util.js"></script>

<dom-module id="rebelcricket-design">
  <template>
    <style is="custom-style">    

      paper-button.custom {
        background: white;
        color: #333;
      }

      paper-button.custom:hover {
        background: #333;
        color: white;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-toggle-button.green {
        --paper-toggle-button-checked-bar-color:  var(--paper-green-500);
        --paper-toggle-button-checked-button-color:  var(--paper-green-500);
        --paper-toggle-button-checked-ink-color: var(--paper-green-500);
        --paper-toggle-button-unchecked-bar-color:  var(--paper-teal-500);
        --paper-toggle-button-unchecked-button-color:  var(--paper-teal-500);
        --paper-toggle-button-unchecked-ink-color: var(--paper-teal-500);
      }

      .container{
        text-align: center;
      }

      .flex-wrap {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      .flex-wrap div {
        min-width: 200px;
      }

      #design-controls{
        text-align: center;
        padding: 1em;
      }
      #design-element-container{
        width: 530px;
        height: 630px;
        position: relative;
      }

      #design-element-img-container{
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      #design-element-canvas-container {

        position: absolute;
        top:115px;
        left: 165px;
        z-index: 2;
      }

      canvas:hover{
        border:thin solid #ccc;
      }


      #catInput{
        display: none;
      }
      @media (max-width: 767px) {


      }

    </style>

    <app-pouchdb-document
      db-name="http://localhost:5984/cats"
      doc-id="parsnip"
      data="{{cat}}">
    </app-pouchdb-document>

      <app-pouchdb-document
        db-name="http://localhost:5984/cats"
        doc-id="mydoc"
        data="{{mydoc}}">
      </app-pouchdb-document>

    <app-pouchdb-index
      db-name="http://localhost:5984/cats"
      fields='["name"]'>
    </app-pouchdb-index>
    <app-pouchdb-query
      db-name="http://localhost:5984/cats"
      selector="name $exists true"
      fields='["_id","name"]'
      sort='["name"]'
      data="{{cats}}">
    </app-pouchdb-query>

    <app-pouchdb-query
      db-name="http://localhost:5984/cats"
      selector="_attachments $exists true"
      fields='["_id","_attachments"]'
      data="{{designImages}}">
    </app-pouchdb-query>

    <div class="container">
    <header>
      <h1>Design</h1>
    </header>
    <div class="flex-wrap">
      <div id="design-controls">
        <input
          id="catInput"
          is="iron-input"
          bind-value="{{cat.name}}">
        </input>
        <br>
        <paper-dropdown-menu label="Style" on-iron-select="styleSelected">
          <paper-listbox class="dropdown-content" selected="0">
            <paper-item value="crew">Crew</paper-item>
            <paper-item value="womens_crew">Women's Crew</paper-item>
            <paper-item value="hoodie">Hoodie</paper-item>
            <paper-item value="longsleeve">Long Sleeve</paper-item>
            <!-- <paper-item value="tank">Tank</paper-item> -->
          </paper-listbox>
        </paper-dropdown-menu>
        <br>
        <paper-toggle-button class="green" id="toggle-design-element-img" on-tap="toggleDesignElementImg">Back</paper-toggle-button>
        <br>
        <paper-swatch-picker color="{{designElementColor}}" column-count=5 color-list='["#65a5f2", "#83be54", "#f0d551", "#e5943c", "#a96ddb"]'></paper-swatch-picker>

      </div>
      <div id="design-element-container">
        <div id="design-element-img-container">
          <img id="design-element-img">
        </div>
        <div id="design-element-canvas-container">
          <canvas id="c" width="200" height="400"></canvas>
        </div>
      </div>
      <div>


        <template is="dom-repeat" items="{{designImages}}">
          <template is="dom-repeat" items="{{_attachmentKeys(item._attachments)}}" as="attachment">
            <img src="http://localhost:5984/cats/{{item._id}}/{{ attachment }}" height="100" width="100">
          </template>
        </template>
        <br>
        <input id="catFile" type="file"></input>
        <br>
        <select>
        <template id="rebelCats" is="dom-repeat" items="{{cats}}">
          <option value="{{item.name">{{item.name}}</option>
        </template>
        </select>

      </div>
    </div>
    </div>

  </template>

  <script>

  Polymer({
    is: 'rebelcricket-design',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      designElementColor: String
    },
    listeners: {
      'color-picker-selected': 'designElementColorChange'
    },
    // _toArray: function(obj) {
    //   return Object.keys(this.mydoc).map(function(key) {
    //     return {
    //         name: key,
    //         value: this.mydoc[key]
    //     };
    //   });
    // },
    designElementColorChange: function(e){
      console.log('designElementColorChange',e.detail.color);
      console.log("this.$$('#design-element-img'):",this.$$('#design-element-img'));
      // var t = Polymer.dom(e).localTarget; // design-element-img-container
      this.$$('#design-element-img').setAttribute('style', 'background-color:'+e.detail.color);
      // t.customStyle['--background-color'] = e.detail.color;
      // customStyle['--color'] 
      // .customStyle['--an-ele-name-bgcolor'] = 'pink'; //background-color
      // t.updateStyles();
      // Polymer.updateStyles();
    },
    styleSelected: function(e){
      this.$$('#design-element-img').src = '/images/design/'+e.target.selectedItem.getAttribute('value')+'_front.png';
      this.$$('#toggle-design-element-img').checked = false;
    },
    toggleDesignElementImg: function(e){
      console.log('toggleDesignElementImg e.target.checked:',e.target.checked);
      if(e.target.checked){
        this.$$('#design-element-img').src = this.$$('#design-element-img').src.replace(/front/, 'back');
        e.target.innerHTML = 'Front';
      }else{
        this.$$('#design-element-img').src = this.$$('#design-element-img').src.replace(/back/, 'front');
        e.target.innerHTML = 'Back';
      }
    },
    _log: function(wut){
      console.log('wut:',wut);
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    // _getImgSrc: function(attachment){
    //   var db = new PouchDB('http://localhost:5984/cats');
    //   db.getAttachment('mydoc', attachment).then(function (blobOrBuffer) {
    //     return URL.createObjectURL(blobOrBuffer);
    //   }).catch(function (err) {
    //     console.log(err);
    //   });
    //   // Object.keys(attachment);
    //   // console.log('_getImgSrc:',attachment);
    //   // console.log('_getImgSrc:',URL.createObjectURL(attachment));
    //   // return URL.createObjectURL(attachment);
    // },
    ready: function(){

      // console.log('mydoc:',this.mydoc);

      var canvas = new fabric.Canvas(this.$.c);

      var rect = new fabric.Rect({
          top : 100,
          left : 100,
          width : 60,
          height : 70,
          fill : 'red'
      });

      canvas.add(rect);

      //file upload
      var db = new PouchDB('http://localhost:5984/cats');

      var catImage = this.$.catImage;

      // console.log('designImages:',this.designImages);

      // var images = [];
      // db.get('mydoc').then(function (doc) {
      //   // var img = document.createElement('img');
      //   // Polymer.dom(this.$.designImages).appendChild(img);
      //   for(var key in doc._attachments) {
      //     // skip loop if the property is from prototype
      //     if (!doc._attachments.hasOwnProperty(key)) continue;
      //     // var obj = doc._attachments[key];
      //     db.getAttachment('mydoc', key).then(function (blobOrBuffer) {
      //       console.log('URL.createObjectURL(blobOrBuffer):',URL.createObjectURL(blobOrBuffer));
      //       console.log('blobOrBuffer:',blobOrBuffer);
      //       // console.log('blobUtil.createObjectURL(blobOrBuffer):',blobUtil.createObjectURL(blobOrBuffer));
      //       images.push({ src: URL.createObjectURL(blobOrBuffer) });
      //     }).catch(function (err) {
      //       console.log(err);
      //     });

      //   }

      //   //this.pushImages(images);
      //   //this.designImages.push(images);
        

      // });

      

      

      var input = this.$.catFile;
      input.addEventListener('change', function () {
        var file = input.files[0]; // file is a Blob

        // console.log('input file:',file);

        // var attachments = {};
        // attachments[file.name] = {
        //   content_type: file.type,
        //   type: file.type,
        //   data: file
        // }

        // db.put({
        //   _id: 'mydoc',
        //   _attachments: attachments
        // }).catch(function (err) {
        //   console.log(err);
        // });

        // var attachment = new Blob(file, {type: file.type});
        db.putAttachment(file.name, file.name, file, file.type).then(function (result) {
          // handle result
        }).catch(function (err) {
          console.log(err);
        });



      });

    }


  });


  </script>
</dom-module>
