<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="rebelcricket-pouchdb.html"> -->
<link rel="import" href="../bower_components/app-pouchdb/pouchdb.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-database-behavior.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-index.html">
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-query.html"> 
<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">
<!-- <link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-conflict-resolution.html"> -->
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<script src="../bower_components/pouchdb/dist/pouchdb.js"></script>
<script src="../bower_components/pouchdb-find/dist/pouchdb.find.js"></script>
<script src="../bower_components/fabric.js/dist/fabric.js"></script>
<script src="../bower_components/blob-util/dist/blob-util.js"></script>
<script src="fabric-filters.js"></script>
<script src="util.js"></script>
<dom-module id="rebelcricket-design">
  <template>
    <style is="custom-style" include="rebelcricket-common-styles">    

      paper-button.custom {
        background: white;
        color: #333;
      }

      paper-button.custom:hover {
        background: #333;
        color: white;
      }

      paper-button[disabled] {
        background: #333;
        color: gray;
      }

      paper-toggle-button.green {
        --paper-toggle-button-checked-bar-color:  var(--paper-green-500);
        --paper-toggle-button-checked-button-color:  var(--paper-green-500);
        --paper-toggle-button-checked-ink-color: var(--paper-green-500);
        --paper-toggle-button-unchecked-bar-color:  var(--paper-teal-500);
        --paper-toggle-button-unchecked-button-color:  var(--paper-teal-500);
        --paper-toggle-button-unchecked-ink-color: var(--paper-teal-500);
      }

      .center{
        text-align: center;
      }

      .flex-wrap {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      .flex-wrap div {
        min-width: 200px;
      }

      #design-controls, #objectTools{
        padding-left: 2em;
      }

      #design-element-container{
        width: 530px;
        height: 630px;
        position: relative;
      }

      #design-element-img-container{
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      #design-element-canvas-container {

        position: absolute;
        top:115px;
        left: 165px;
        z-index: 2;
      }

      canvas:hover{
        border:thin solid #ccc;
      }

      .controls label{
        font-size: 16px;

      }
      .controls {
        margin-top: 16px;
        line-height: 14px;
      }
      .controls div{
        margin-top: 10px;
      }

      @media (max-width: 767px) {


      }

    </style>

<!--     <app-pouchdb-document
      db-name="http://localhost:5984/cats"
      doc-id="parsnip"
      data="{{cat}}">
    </app-pouchdb-document> -->

    <app-pouchdb-document
        db-name="http://localhost:5984/order_designs"
        doc-id="{{designID}}"
        data="{{orderDesign}}">
      </app-pouchdb-document>

    <app-pouchdb-index
      db-name="http://localhost:5984/design"
      fields='["name"]'>
    </app-pouchdb-index>
<!--     <app-pouchdb-query
      db-name="http://localhost:5984/cats"
      selector="name $exists true"
      fields='["_id","name"]'
      sort='["name"]'
      data="{{cats}}">
    </app-pouchdb-query> -->

    <app-pouchdb-query
      db-name="http://localhost:5984/order_designs"
      selector="_attachments $exists true"
      fields='["_id","_attachments"]'
      data="{{orderDesignAttachments}}">
    </app-pouchdb-query>

    <div class="container">
    <header class="center">
      <h1 class="rebelcricket-header">Design</h1>
    </header>
    <div class="flex-wrap">
      <div id="design-controls">
        <paper-dropdown-menu label="Style" on-iron-select="_styleSelected">
          <paper-listbox class="dropdown-content" selected="{{orderDesign.style}}">
            <paper-item value="crew">Crew</paper-item>
            <paper-item value="womens_crew">Women's Crew</paper-item>
            <paper-item value="hoodie">Hoodie</paper-item>
            <paper-item value="longsleeve">Long Sleeve</paper-item>
            <!-- <paper-item value="tank">Tank</paper-item> -->
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-swatch-picker color="[[orderDesign.designElementColor]]" column-count=4 color-list='["#000000", "#65a5f2", "#83be54", "#f0d551", "#e5943c", "#a96ddb", "#B20000", "#ffffff"]'></paper-swatch-picker>
        <br><br>
        <paper-toggle-button class="green" id="toggle-design-element-img" on-tap="_toggleDesignElementImg">Show Back</paper-toggle-button>
        <br>
        <label for="orderDesignFile">Add Image</label>
        <input id="orderDesignFile" type="file"></input>
        <br><br>
   <!--      <input
          id="catInput"
          is="iron-input"
          bind-value="{{cat.name}}">
        </input> -->
<!-- 
        <template is="dom-repeat" items="{{orderDesign}}">
          <template is="dom-repeat" items="{{_attachmentKeys(item._attachments)}}" as="attachment">
            <img src="http://localhost:5984/cats/{{item._id}}/{{ attachment }}" height="50" width="50">
          </template>
        </template>
        <br> -->

        
      </div>
      <div id="design-element-container">
        <div id="design-element-img-container">
          <img id="design-element-img" style$="background-color: [[orderDesign.designElementColor]]" crossOrigin="Anonymous">
        </div>
        <div id="design-element-canvas-container">
          <canvas id="c" width="200" height="400"></canvas>
        </div>
      </div>
      <div>

        <div id="objectTools" hidden$="{{objectToolsHidden}}">
          <paper-button class="custom" id="removeImage" on-tap="_removeImageFromCanvas" raised>remove image</paper-button>

          <div class="controls">
            <div>
              <label><span>Grayscale:</span> <input type="checkbox" id="grayscale"></label>
              <label><span>Invert:</span> <input type="checkbox" id="invert"></label>
            </div>
            <div>
              <label><span>Sepia:</span> <input type="checkbox" id="sepia"></label>
              <label><span>Sepia2:</span> <input type="checkbox" id="sepia2"></label>
            </div>
            <div>
              <label><span>Remove white:</span> <input type="checkbox" id="remove-white"></label>
              <br>
              <label>Threshold: <input type="range" id="remove-white-threshold" value="60" min="0" max="255"></label>
              <br>
              <label>Distance: <input type="range" id="remove-white-distance" value="10" min="0" max="255"></label>
            </div>
            <div>
              <label><span>Brightness:</span> <input type="checkbox" id="brightness"></label>
              <br>
              <label>Value: <input type="range" id="brightness-value" value="100" min="-255" max="255"></label>
            </div>
            <div>
              <label><span>Contrast:</span> <input type="checkbox" id="contrast"></label>
              <br>
              <label>Value: <input type="range" id="contrast-value" value="0" min="-255" max="255"></label>
            </div>
            <div>
              <label><span>Saturate:</span> <input type="checkbox" id="saturate"></label>
              <br>
              <label>Value: <input type="range" id="saturate-value" value="100" min="-100" max="100"></label>
            </div>
            <div>
              <label><span>Noise:</span> <input type="checkbox" id="noise"></label>
              <br>
              <label>Value: <input type="range" id="noise-value" value="100" min="0" max="1000"></label>
            </div>
            <div>
              <label><span>GradientTransparency:</span> <input type="checkbox" id="gradient-transparency"></label>
              <br>
              <label>Value: <input type="range" id="gradient-transparency-value" value="100" min="0" max="255"></label>
            </div>
            <div>
              <label><span>Pixelate</span> <input type="checkbox" id="pixelate"></label>
              <br>
              <label>Value: <input type="range" id="pixelate-value" value="4" min="2" max="20"></label>
            </div>
            <div>
              <label><span>Blur:</span> <input type="checkbox" id="blur"></label>
              <label><span>Sharpen:</span> <input type="checkbox" id="sharpen"></label>
              <label><span>Emboss:</span> <input type="checkbox" id="emboss"></label>
            </div>
            <div>
              <label><span>Tint:</span> <input type="checkbox" id="tint"></label>
              <input type="color" id="tint-color" value=""><br>
              <label>Opacity: <input type="range" id="tint-opacity" min="0" max="1" value="1" step="0.1"></label><br>
            </div>
            <div>
              <label><span>Multiply:</span> <input type="checkbox" id="multiply"></label>
              <input type="color" id="multiply-color" value="">
            </div>
            <div>
            <label><span>Blend:</span> <input type="checkbox" id="blend"></label>
              <select id="blend-mode" name="blend-mode">
                <option selected="" value="add">Add</option>
                <option value="diff">Diff</option>
                <option value="subtract">Subtract</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="lighten">Lighten</option>
                <option value="darken">Darken</option>
              </select>
              <input type="color" id="blend-color" value="#00f900">
            </div>
          </div>




        </div>
      
        
       <!--  <br>
        <select>
        <template id="rebelCats" is="dom-repeat" items="{{cats}}">
          <option value="{{item.name">{{item.name}}</option>
        </template>
        </select> -->

      </div>
    </div>
    </div>

  </template>

  <script>
  var canvasNeedsInit = false;

  Polymer({
    is: 'rebelcricket-design',
    behaviors: [
      Polymer.AppPouchDBDatabaseBehavior
    ],
    properties: {
      designElementColor: String,
      canvas: {
        type: Object,
        notify: true
      },
      orderDesign: {
        type: Object,
        notify: true
        // value: function() { return {}; }
      },
      orderDesignAttachments: {
        type: Object,
        notify: true
      },
      objectToolsHidden: {
        type: Boolean,
        notify: true,
        value: true // this might need to be false? https://www.polymer-project.org/1.0/docs/devguide/properties#configure-values
      },
      designID: {
        type: String,
        notify: false,
        value: function() { 
          if(window.location.hash === ''){
            window.location.hash = generateGUID();
          }
          return window.location.hash.replace(/#/,'');
        }
      }

    },
    listeners: {
      'color-picker-selected': '_designElementColorChange',
      'order-design-changed': '_orderDesignChanged',
      'order-design-attachments-changed': '_orderDesignAttachmentsChanged'
    },
    _designElementColorChange: function(e){
      this.set('orderDesign.designElementColor', e.detail.color);
      this.$$('#design-element-img').setAttribute('style', 'background-color:'+e.detail.color);
    },
    _styleSelected: function(e){
      this.$$('#design-element-img').src = '/images/design/'+e.target.selectedItem.getAttribute('value')+'_front.png';
      this.$$('#toggle-design-element-img').checked = false;
    },
    _toggleDesignElementImg: function(e){
      console.log('_toggleDesignElementImg e.target.checked:',e.target.checked);
      if(e.target.checked){
        this.$$('#design-element-img').src = this.$$('#design-element-img').src.replace(/front/, 'back');
        e.target.innerHTML = 'Show Front';
      }else{
        this.$$('#design-element-img').src = this.$$('#design-element-img').src.replace(/back/, 'front');
        e.target.innerHTML = 'Show Back';
      }
    },
    _orderDesignChanged: function(e){

      console.log('DESIGN _orderDesignChanged, canvasNeedsInit:', canvasNeedsInit);
      if(this.orderDesign.canvas && canvasNeedsInit){
        canvasNeedsInit = false;
        // this.set('canvasNeedsInit', false);
        console.log('CANVAS tryin to load JSON:',this.orderDesign.canvas);
        this._clearCanvas();
        this.canvas.loadFromJSON(this.orderDesign.canvas);
      }
      
    },
    _orderDesignAttachmentsChanged: function(e){
      this.set('orderDesignAttachments', e.detail.value);
      console.log('_orderDesignAttachmentsChanged e.detail:',e.detail.value,' this.orderDesignAttachments',this.orderDesignAttachments);
      this._clearCanvas();
      for(var key in this.orderDesignAttachments){
        var attachments = Object.keys(this.orderDesignAttachments[key]._attachments);
        for(var aKey in attachments){
          if(this.orderDesignAttachments[key]._id === this.designID + '_attachments'){
            console.log('src:','http://localhost:5984/order_designs/'+this.orderDesignAttachments[key]._id+'/'+attachments[aKey] )
            e.target._addImageToCanvas('http://localhost:5984/order_designs/'+this.orderDesignAttachments[key]._id+'/'+attachments[aKey]);
          }
          
        }
      }
    },
    _clearCanvas: function(e){
      if(this.canvas){
        this.canvas.clear();
      }
    },
    _addImageToCanvas: function(url){
      var _thisCanvas = this.canvas; //ugh, scope
      fabric.Image.fromURL(url, function(oImg) {
        oImg.scaleToWidth(200);
        _thisCanvas.add(oImg);
      },{ crossOrigin: 'Anonymous' });
    },
    _removeImageFromCanvas: function(e){
      console.log('_removeImageFromCanvas idx:',this.canvas.getActiveObject());
      // this.canvas.item(this.$.removeImage.getAttribute('idx')).remove();
      this.canvas.getActiveObject().remove();
      // this.canvas.remove(obj);
    },
    _log: function(wut){
      console.log('wut:',wut);
    },
    _attachmentKeys: function(attachments){
      if(attachments != undefined){
        return Object.keys(attachments);
      }
    },
    _onObjectSelected: function(e){
       this.set('objectToolsHidden', false);
    },
    _onSelectionCleared: function(e){
      this.set('objectToolsHidden', true);
    },
    _onObjectModified: function(e){
      e.target.opacity = 1;
      this.set('orderDesign.canvas', this.canvas);
      // console.log('CANVAS JSON, should match:',JSON.stringify(this.canvas), this.orderDesign.canvas);
    },
    ready: function(){

      console.log('DESIGN this.orderDesign.canvas?', this.orderDesign.canvas);
      this.canvas = new fabric.Canvas(this.$.c);

      // draw something
      // var rect = new fabric.Rect({
      //     top : 100,
      //     left : 100,
      //     width : 60,
      //     height : 70,
      //     fill : 'red'
      // });
      // this.canvas.add(rect);
      
      
      canvasNeedsInit = true;

      initFabricFilters(this);

      this.canvas.on({
       'object:moving': function(e) {       
          e.target.opacity = 0.5;
          //snap to edge of canvas #TODO: look up canvas height/width
          if(e.target.top > -5 && e.target.top < 5){
            e.target.set({
              top: 0,
            });
          }
          if(e.target.right > 195 && e.target.right < 205){
            e.target.set({
              right: 200,
            });
          }
          if(e.target.bottom > 395 && e.target.bottom < 405){
            e.target.set({
              bottom: 400,
            });
          }
          if(e.target.left > -5 && e.target.left < 5){
            e.target.set({
              left: 0,
            });
          }

        },
       //very important, need to bind to this scope...
       'object:modified': this._onObjectModified.bind(this),
       'object:selected': this._onObjectSelected.bind(this),
       'selection:cleared': this._onSelectionCleared.bind(this)
      });

      //file upload
      var db = new PouchDB('http://localhost:5984/order_designs');

      var input = this.$.orderDesignFile;
      var _this = this;
      input.addEventListener('change', function () {
        var file = input.files[0]; // file is a Blob

        db.putAttachment(_this.designID+'_attachments', file.name, file, file.type).then(function (result) {
          // handle result
          _this._addImageToCanvas('http://localhost:5984/order_designs/'+_this.designID+'_attachments/'+file.name);
        }).catch(function (err) {
          console.log(err);
        });

      });

    }


  });


  </script>
</dom-module>
