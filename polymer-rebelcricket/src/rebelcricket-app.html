<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">


<link rel="import" href="rebelcricket-common-styles.html">
<link rel="import" href="rebelcricket-icons.html">
<link rel="import" href="rebelcricket-header.html">
<!-- 
<link rel="import" href="rebelcricket-contact.html">
<link rel="import" href="rebelcricket-order.html">
<link rel="import" href="rebelcricket-orders.html">
<link rel="import" href="rebelcricket-design.html"> -->

<!-- 'home' is the default route, eagerly load it. -->
<link rel="import" href="rebelcricket-home.html">

<dom-module id="rebelcricket-app">
  <template>
    <style include="rebelcricket-common-styles">
      :host {
        display: block;
        color: black;
        background-color: white;
      }

    </style>
  
    <!--
      app-location and app-route elements provide the state of the URL for the app.
    -->
    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>
    
    <rebelcricket-header></rebelcricket-header>

    <iron-pages role="main" selected="[[page]]" attr-for-selected="name" selected-attribute="visible">
      <!-- home view -->
      <rebelcricket-home name="home" ></rebelcricket-home>
      <rebelcricket-contact name="contact"></rebelcricket-contact>
      <rebelcricket-design name="design"></rebelcricket-design>
      <rebelcricket-order name="order" route="[[subroute]]" offline="[[offline]]"></rebelcricket-order>
      <rebelcricket-orders name="orders"></rebelcricket-orders>
      <!-- list view of items in a category -->
      <rebelcricket-list name="list" route="[[subroute]]" offline="[[offline]]"></rebelcricket-list>
      <!-- detail view of one item -->
      <rebelcricket-detail name="detail" route="[[subroute]]" offline="[[offline]]"></rebelcricket-detail>
    </iron-pages>

    <iron-media-query query="max-width: 767px" query-matches="{{smallScreen}}"></iron-media-query>

    




    <footer>
      <a href="http://lacuna.club">Made with &hearts; in Portland, Oregon</a>

    </footer>

  </template>

  <script>
    Polymer({

      is: 'rebelcricket-app',

      properties: {
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        }
      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      listeners: {
        'change-section': '_onChangeSection'
      },


      _routePageChanged: function(page) {
        this.page = page || 'home';
        // Scroll to the top of the page on every *route* change. Use `Polymer.AppLayout.scroll`
        // with `behavior: 'silent'` to disable header scroll effects during the scroll.
        var headerOffset = 0;
        if(page != 'home'){
          try{
            //this querySelector doesn't work in safari :(
            headerOffset = document.querySelector('rebelcricket-app::shadow app-header').clientHeight;
          }catch(err){
            //o noz!
          }
          
        }
        Polymer.AppLayout.scroll({ 
          top: headerOffset, 
          behavior: 'silent' 
        });
        
      },

      _pageChanged: function(page, oldPage) {
        if (page != null) {
          // home route is eagerly loaded
          if (page == 'home') {
            this._pageLoaded(Boolean(oldPage));
          // other routes are lazy loaded
          } else {
            this.importHref(
              this.resolveUrl('rebelcricket-' + page + '.html'),
              function() {
                this._pageLoaded(Boolean(oldPage));
              }, null, true);
          }
        }
      },

      _pageLoaded: function(shouldResetLayout) {
        this._ensureLazyLoaded();
        if (shouldResetLayout) {
          // The size of the header depends on the page (e.g. on some pages the tabs
          // do not appear), so reset the header's layout only when switching pages.
          this.async(function() {
            this.$.header.resetLayout();
          }, 1);
        }
      },

      _ensureLazyLoaded: function() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function() {
            // if ('serviceWorker' in navigator) {
            //   navigator.serviceWorker.register('/service-worker.js');
            // }
            this.loadComplete = true;

            // this.importHref(this.resolveUrl('lazy-resources.html'), function() {
            //   // Register service worker if supported.
            //   // this._notifyNetworkStatus();
            // });
          });
        }
      },

      // Elements in the app can notify section changes.
      // Response by a11y announcing the section and syncronizing the category.
      _onChangeSection: function(event) {
        // var detail = event.detail;
        // this.categoryName = detail.category || '';
        // // Announce the page's title
        // if (detail.title) {
        //   document.title = detail.title + ' - Rebel Cricket';
        //   this._announce(detail.title + ', loaded');
        // }

      },

    });
  </script>
</dom-module>
