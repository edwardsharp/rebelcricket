<div *ngIf="!order" class="content">
	<div class="header">
	  <h2 class="name">Loading Order...</h2>
	  <mat-spinner></mat-spinner>
	</div>
</div>

<div *ngIf="order" class="content">
  <mat-toolbar color="primary" class="sticky">
		<button mat-icon-button aria-label="Back to dasboard" routerLink="/dashboard/" matTooltip="Back to Dashboard">
    	<mat-icon class="mat-24">arrow_back</mat-icon>
  	</button>

  	<!-- this is a oneliner mess cuz the stylez for this h2 care about \n -->
	  <mat-form-field class="hidden" >
      <input matInput [matDatepicker]="picker" [(ngModel)]="order.date_needed" placeholder="Due Date" readonly="true">
      <mat-datepicker touchUi="true" #picker></mat-datepicker>
    </mat-form-field>
	  <h2 class="order-toolbar">
	  	<small matTooltip="Created At"><mat-icon>event</mat-icon> <span>{{order.created_at | date:'short' }}</span></small>
	  	<small 
	  		*ngIf="order.date_needed; else needByDateElse" 
	  		(click)="picker.open()"
        matTooltip="Due Date"><mat-icon>alarm</mat-icon> <span>{{order.date_needed | date:'shortDate'}}</span></small>
	  	<ng-template #needByDateElse><small (click)="picker.open()"><mat-icon matTooltip="No Due Date">alarm_off</mat-icon> <span>No Due Date</span></small></ng-template>
    </h2>  
	  
	  <span class="flexfill"></span>

	  <span *ngIf="settings?.order_statuses; else elseBlock">
		  <mat-chip [matMenuTriggerFor]="orderStatusMenu">{{order.status}}</mat-chip>
		  <mat-menu #orderStatusMenu="matMenu">
		    <button mat-menu-item 
		    	*ngFor="let status of settings.order_statuses"
		    	(click)="order.status = status.name; saveOrder()">
		      <span>{{status.name}}</span>
		    </button>
		  </mat-menu>
	  </span>
    <ng-template #elseBlock><mat-chip>{{order.status}}</mat-chip></ng-template>

		<button mat-icon-button [matMenuTriggerFor]="orderDetailMenu">
	    <mat-icon class="example-icon">more_vert</mat-icon>
	  </button>
	  <mat-menu #orderDetailMenu="matMenu">
	  	<button mat-menu-item (click)="clearDueDate()" [disabled]="!order.date_needed">
	      <mat-icon>alarm_off</mat-icon>
	      <span>Clear Due Date</span>
	    </button>
	    <button mat-menu-item (click)="deleteOrder()">
	      <mat-icon>delete</mat-icon>
	      <span>delete</span>
	    </button>
	  </mat-menu>


	</mat-toolbar>

<!-- 	<mat-tab-group class="order-details">
	  <mat-tab label="Details">
	  </mat-tab>
	  <mat-tab label="Attachments ({{attachmentItemsForOrder().length}})">
	  </mat-tab>
	  <mat-tab label="{{historyLabel()}}">
	  </mat-tab>
	</mat-tab-group> -->

	<div id="details">
		<app-order-tags [tags]="order.tags" (tagsChanged)="tagsChanged($event)"></app-order-tags>
	  	
  	<div>
		  <mat-form-field>
		    <input matInput [(ngModel)]="order.name" (change)="onChange($event)" placeholder="name">
		  </mat-form-field>
		  <mat-form-field>
		    <input matInput [(ngModel)]="order.org" (change)="onChange($event)" placeholder="org">
		  </mat-form-field>
		  
		</div>
		<div>
			<mat-form-field class="with-button">
		    <input matInput [(ngModel)]="order.email" (change)="onChange($event)" placeholder="email">
		  </mat-form-field>
		  <button mat-icon-button 
        *ngIf="order.email"
        matTooltip="Email {{order.email}}">
        <mat-icon class="icon">mail_outline</mat-icon>
      </button>
		  <mat-form-field class="with-button">
		    <input matInput [(ngModel)]="order.phone" (change)="onChange($event)" placeholder="phone">
		  </mat-form-field>
		  <button mat-icon-button 
        *ngIf="order.phone"
        matTooltip="Call {{order.phone}}">
        <mat-icon class="icon">phone</mat-icon>
      </button>
		</div>
	  <div>
		  <mat-form-field class="fullwidth">
		    <textarea matInput [(ngModel)]="order.notes" (change)="onChange($event)" placeholder="notes"></textarea>
		  </mat-form-field>
		</div>

	  <mat-list>
		  <mat-list-item *ngFor="let service of order.services">{{service}}</mat-list-item>
		</mat-list>

		<!-- <h3 *ngIf="order.line_items">Services ({{order.line_items.length}})</h3> -->
	  <div *ngFor="let line_item of order.line_items" class="line-items">
	  	<section class="sticky sticky-service">
	  		<button mat-icon-button (click)="removeOrderLineItem(line_item)"
	  			matTooltip="Delete Line Item">
		      <mat-icon>delete</mat-icon>
		    </button>
		  	<mat-form-field class="li-service">
			    <input matInput value="{{line_item.service_label}}" placeholder="Service" type="text" readonly="true">
			  </mat-form-field>
		  	<span class="flexfill"></span>

		  	<a *ngIf="line_item.service && line_item.service.vendor_goods_catalog" mat-icon-button [routerLink]="['/dashboard/vendor_goods/',line_item.service.vendor_goods_catalog, { order_id: order._id, line_item_id: line_item.service_label }]"
	  			matTooltip="Browse Vendor Goods">
		      <mat-icon>shopping_basket</mat-icon>
		    </a>

			  <mat-form-field class="total">
			    <input matInput [(ngModel)]="line_item.quantity" placeholder="Total" type="number" readonly="true">
			    ${{line_item?.total?.toFixed(2)}}
			  </mat-form-field>

			</section>
  		
  		<div *ngFor="let vendor_good of line_item.vendor_goods">
  			<div style="display:flex;align-items:center;text-align:center;">
	  			
	  			<span class="flexfill">{{vendor_good.vendor_title}} </span>
	  			<button mat-icon-button matTooltip="Remove Vendor Good" 
	  				(click)="deleteVendorGoodItem(line_item.vendor_goods,vendor_good,line_item)">
	  				<mat-icon>delete</mat-icon>
	  			</button>
	  		</div>

  			<div *ngFor="let sel_item of vendor_good.selected_items">
  				color: {{sel_item.color}}
					
					<div style="display: flex;">
  					<mat-form-field class="quantity" *ngFor="let size_price of sel_item.size_prices">
					    <input matInput [(ngModel)]="size_price.quantity" (change)="sizeQtyChanged(sel_item, line_item)" placeholder="{{size_price.size}}" type="number">
					    {{size_price.price}}
					  </mat-form-field>

					  <mat-form-field class="total">
					    <input matInput [(ngModel)]="sel_item.qty_total" placeholder="Total" type="number" readonly="true">
					    ${{sel_item?.price_total?.toFixed(2)}}
					  </mat-form-field>

					  <button mat-icon-button matTooltip="Remove {{sel_item.color}}" 
					  	(click)="deleteVendorGoodItem(vendor_good.selected_items,sel_item,line_item)">
					  	<mat-icon>delete</mat-icon></button>
	  			</div>

  			</div>

  			
  		</div>

	  	<div *ngFor="let field of line_item.items" class="service-line-items">
	  		
	  		
	  		<mat-form-field *ngIf="field.type == order_field_types['Text']" class="service-line-item">
	  			<input matInput [(ngModel)]="field.value" (change)="onChange($event)" placeholder="{{field.name}}" type="text">
	  		</mat-form-field>
	  		<mat-form-field *ngIf="field.type == order_field_types['Textarea']" class="service-line-item">
	  			<textarea matInput [(ngModel)]="field.value" (change)="onChange($event)" placeholder="{{field.name}}" type="number"></textarea>
	  		</mat-form-field>
	  		<mat-checkbox *ngIf="field.type == order_field_types['Checkbox']" 
	  			[(ngModel)]="field.value" (change)="onChange($event)">{{field.name}}</mat-checkbox>
	  		<mat-form-field *ngIf="field.type == order_field_types['Number']" class="service-line-item">
	  			<input matInput [(ngModel)]="field.value" (change)="onChange($event)" placeholder="{{field.name}}" type="number">
	  		</mat-form-field>
	  		<mat-select *ngIf="field.type == order_field_types['Select']" 
	  			placeholder="{{field.name}}" [(ngModel)]="field.value">
				  <mat-option *ngFor="let item of field.select_items" [value]="item.value">
				    {{ item.name }}
				  </mat-option>
				</mat-select>
	  	</div>

		  <div *ngIf="line_item.service?.notes">
		  	<mat-form-field class="fullwidth">
			    <textarea matInput [(ngModel)]="line_item.service.notes" (change)="onChange($event)" placeholder="notes"></textarea>
			  </mat-form-field>
			</div>

	  </div>
	</div>


	<div id="attachments">

		<section class="sticky sticky-service">
			<h3>Graphics ({{attachmentItemsForOrder().length}})</h3>
		</section>	

		<div id="new-attachment">
	  	<label for="quoteDesignFile"><mat-icon>add</mat-icon>Upload Image Files</label>
      <input id="quoteDesignFile" type="file" multiple="multiple" (change)="quoteFileChnaged($event)" (disabled)="quoteDesingUploading" />
      <mat-progress-bar mode="indeterminate" [hidden]="!quoteDesingUploading"></mat-progress-bar>
      
      <span id="quoteDesignUploadFeedback" [hidden]="!gfxError">
        ERROR! Could not upload that file. Please try again or choose a different file. If this form does not work for you please email your graphics to <a href="#">foobar@example.com</a>.
      </span>
      <div>
        <small>Upload: <b>ai, eps, pdf, psd, svg, jpeg, or tiff</b> sized at <b>300 dpi</b>.</small>
      </div>
    </div>

    <div *ngFor="let item of attachmentItemsForOrder()" class="attachment-cards">
		  <mat-card>
	
				  <img mat-card-image class="attachment-img" alt="{{item}}" [src]="sanitizer.bypassSecurityTrustUrl(attachmentSrcFor(order, item))" />
				  <!-- <mat-card-content>
				    <p></p>
				  </mat-card-content> -->
				  <mat-card-actions>
				  	<span class="flexfill"></span>
				  	<span class="item-key" title="{{item}}">{{item}}</span>
				    <span class="flexfill"></span>
				    <button mat-icon-button (click)="deleteAttachmentFor(item);"><mat-icon>delete</mat-icon></button>
				  </mat-card-actions>
				</mat-card>
		
		</div>
	</div>


	<div id="history">
		<section class="sticky sticky-service">
			<h3>History</h3>
		</section>
	 <mat-expansion-panel class="mat-elevation-z0">
    <mat-expansion-panel-header>
      {{historyLabel()}}
    </mat-expansion-panel-header>
    <dl>
    	<div *ngFor="let item of order.history?.reverse() ">
		  <dt>{{item.date | date:'short' }}</dt>
		  <dd>
		    {{item.title}} 
				{{item.description}} 
		  </dd>
			</div>
		</dl>
  </mat-expansion-panel>
	</div>

	<mat-action-row>
		<mat-select
			[(ngModel)]="selectedService" placeholder="Add Service">
		  <mat-option *ngFor="let item of settings?.services" [disabled]="serviceNeedsDisabled(item)" [value]="item" (click)="addOrderLineItem()">
		    {{ item.name }}
		  </mat-option>
		</mat-select>

    <span class="flexfill"></span>
    <!-- [disabled]="needsSave" -->
    <button mat-button (click)="saveOrder()">
  		<mat-icon>save</mat-icon>
  		Save Order
  	</button>
  </mat-action-row>
  

</div>
